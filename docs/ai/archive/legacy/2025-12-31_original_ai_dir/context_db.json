{
  "schema_version": "1.1",
  "project": {
    "name": "Unitana",
    "type": "cross-platform mobile app",
    "thesis": "A travel-first decoder ring that shows dual reality side-by-side (temperature, distance, time, currency) so users learn through repeated exposure.",
    "status": {
      "boots_on_ios": true,
      "dashboard_stable": true,
      "first_run_wizard_stable": true
    }
  },
  "operator_preferences": {
    "role": "Executive Operator",
    "delivery_format": {
      "preferred": "downloadable patch zip with full-file replacements",
      "notes": [
        "Each slice ships as a zip that can be unzipped over the repo root.",
        "Include a short list of changed, added, and removed paths.",
        "Include verification commands and smallest-iPhone device check notes."
      ]
    },
    "change_strategy": {
      "default": "small, reversible slices",
      "avoid": [
        "large refactors without a plan",
        "navigation rewrites",
        "core model changes"
      ]
    }
  },
  "working_rules": {
    "verification_commands": [
      "dart format .",
      "flutter analyze",
      "flutter test",
      "flutter run"
    ],
    "device_check": {
      "minimum_target": "smallest iPhone class",
      "focus": [
        "RenderFlex overflows",
        "tile constraints",
        "wizard dot count",
        "modal flows"
      ]
    },
    "engineering_guardrails": {
      "avoid_theme_null_assertions": true,
      "prefer_safe_unicode_escapes": [
        "\\u00B0",
        "\\u20AC"
      ],
      "small_tile_constraints": "Tiles can be roughly 147x147 on small iPhones, designs must degrade gracefully."
    }
  },
  "ai_docs": {
    "source_of_truth": "docs/ai/context_db.json",
    "read_order_for_new_chat": [
      "docs/ai/AI_DOCS_INDEX.md",
      "docs/ai/WORKING_WITH_CHATGPT.md",
      "docs/ai/context_db.json",
      "docs/ai/NEXT_CHAT_HANDOFF_*.md",
      "docs/ai/NEXT_CHAT_PROMPT.md"
    ],
    "goal": "Keep one canonical context database, then point to the latest handoff and prompt. Reduce scattered handoff notes by folding stable learnings back into context_db and chat lessons."
  },
  "uiux": {
    "design_direction": "Soft Geometry",
    "typography": {
      "accent_font": {
        "name": "Shadows Into Light",
        "usage": [
          "Welcome wordmark 'Unitana'",
          "First-run slide headers for 'Home' and 'Destination'",
          "First-run section headers: Units, Clock, Preview",
          "Review: profile name",
          "Review: card titles 'Home' and 'Destination'",
          "Dashboard: app bar profile name"
        ],
        "non_usage": [
          "Review field labels such as City, Time zone, Units, Clock (kept in current font for readability and layout stability)"
        ]
      },
      "alignment": {
        "welcome": "center",
        "wizard_slide_headers": "center",
        "review_profile_pill": "center group (flag + name), edit icon pinned right",
        "dashboard_appbar_title": "center"
      }
    },
    "dashboard_widgets": {
      "hierarchy": {
        "position": "Use two-level hierarchy primarily for navigation and mental grouping, not for duplicating calculations.",
        "top_level_role": "Top-level category sets iconography, modal aesthetic, and default layout behaviors.",
        "sub_level_role": "Subcategory selects the specific tool/calculation; tools can be referenced from multiple categories without copy-paste logic."
      },
      "defaults": {
        "principle": "Default tiles should be high-frequency, low-friction, and demonstrably useful day-to-day for travelers and movers.",
        "behavior": "Hero is fixed at top; grid below is scrollable; empty cells show '+' affordances for adding tools."
      },
      "tablet_policy": {
        "now": "Mobile-first; keep breakpoints conservative and avoid special-case layouts until tablet sprint.",
        "later": "Tablet design should be a full-scope pass (dashboard grid, tool modals, wizard, menus, orientations) with accessibility and ergonomics considered."
      }
    }
  },
  "onboarding": {
    "wizard_steps": {
      "count": 4,
      "order": [
        "Welcome",
        "Home",
        "Destination",
        "Review"
      ],
      "removed": [
        "Profile Name"
      ]
    },
    "profile_naming": {
      "default": "Destination city (example: 'Lisbon')",
      "country_indicator": "Destination flag emoji derived from ISO2 country code when available",
      "edit": "Review step bottom sheet modal",
      "overwrite_rule": "Derived default should not overwrite a user-edited custom name"
    }
  },
  "dashboard": {
    "appbar": {
      "profile_badge": "Destination flag emoji when available",
      "profile_name": "Centered and rendered in Shadows Into Light"
    },
    "layout": {
      "density_knobs": "Tune `_gap`, `_tileHeightRatio`, `_minRowsPhone`, `_minRowsTablet` in `dashboard_board.dart` for board feel.",
      "tablet_support": "Planned as a dedicated spike + implementation sprint; do not partially implement tablet layout hacks during mobile feature work."
    },
    "board": {
      "widget": "DashboardBoard",
      "file": "app/unitana/lib/features/dashboard/widgets/dashboard_board.dart",
      "behavior": [
        "Scroll-driven grid with reserved hero row at top (Places Hero V2).",
        "Placeholders render as '+' tiles; tapping opens tool picker sheet.",
        "User can replace tools via 'Manage tiles' menu; long-press remove supported."
      ],
      "state": [
        "Layout persisted via SharedPreferences (DashboardLayoutController).",
        "Board builds responsively using breakpoints and tile density knobs."
      ]
    },
    "tool_modals": {
      "widget": "ToolModalBottomSheet",
      "file": "app/unitana/lib/features/dashboard/widgets/tool_modal_bottom_sheet.dart",
      "behavior": [
        "Top half input form, bottom portion shows execution history (last 10).",
        "Supports Height, Baking, Liquids, Area tools via ToolModalKind."
      ]
    },
    "layout_controller": {
      "class": "DashboardLayoutController",
      "file": "app/unitana/lib/features/dashboard/models/dashboard_layout_controller.dart",
      "note": "Loads persisted items. Next slice seeds a default layout when none exists."
    },
    "refresh": {
      "ui": "Top-left refresh icon in DashboardScreen app bar",
      "file": "app/unitana/lib/features/dashboard/dashboard_screen.dart",
      "note": "Refresh must not use BuildContext across async gaps; keep mounted checks aligned."
    }
  },
  "slices": [
    {
      "id": "slice_01",
      "date": "2025-12-27",
      "title": "Dashboard compile hardening + smoke test",
      "summary": [
        "Hardened dashboard data usage against Place model fields.",
        "Added a dashboard widget smoke test sized to smallest-phone constraints."
      ],
      "files": {
        "modified": [
          "app/unitana/lib/features/dashboard/widgets/dashboard_board.dart"
        ],
        "added": [
          "app/unitana/test/dashboard_smoke_test.dart"
        ],
        "removed": []
      }
    },
    {
      "id": "slice_02",
      "date": "2025-12-27",
      "title": "Wizard 5 to 4 slides, move profile naming into Review",
      "summary": [
        "Removed the standalone Profile Name step.",
        "Added Review-based profile naming with default derived from destination and modal editor.",
        "Aligned Review typography and spacing."
      ],
      "files": {
        "modified": [
          "app/unitana/lib/features/first_run/first_run_screen.dart",
          "docs/ai/WORKING_WITH_CHATGPT.md",
          "docs/ai/NEXT_CHAT_PROMPT.md",
          "docs/ai/NEXT_CHAT_HANDOFF_2025-12-27.md"
        ],
        "added": [],
        "removed": []
      }
    },
    {
      "id": "slice_03",
      "date": "2025-12-27",
      "title": "Fix wizard overflow and update widget test",
      "summary": [
        "Fixed a RenderFlex overflow in first-run steps by adding scroll where needed.",
        "Updated widget tests to match the new wizard flow."
      ],
      "files": {
        "modified": [
          "app/unitana/lib/features/first_run/first_run_screen.dart",
          "app/unitana/test/widget_test.dart"
        ],
        "added": [],
        "removed": []
      }
    },
    {
      "id": "slice_04",
      "date": "2025-12-27",
      "title": "Welcome slide refresh + wizard dot count cleanup + font dependency",
      "summary": [
        "Updated Welcome slide layout and added Google Fonts dependency.",
        "Aligned wizard dots to step count and improved Review header behavior."
      ],
      "files": {
        "modified": [
          "app/unitana/lib/features/first_run/first_run_screen.dart",
          "app/unitana/pubspec.yaml",
          "app/unitana/test/widget_test.dart"
        ],
        "added": [],
        "removed": []
      }
    },
    {
      "id": "slice_05",
      "date": "2025-12-27",
      "title": "Typography consistency: Shadows Into Light for circled headers",
      "summary": [
        "Applied Shadows Into Light selectively to slide headers and specific section headers.",
        "Centered Review pill content (flag + profile name) and updated dashboard app bar styling."
      ],
      "files": {
        "modified": [
          "app/unitana/lib/features/first_run/first_run_screen.dart",
          "app/unitana/lib/features/dashboard/dashboard_screen.dart",
          "app/unitana/pubspec.yaml"
        ],
        "added": [],
        "removed": []
      }
    },
    {
      "id": "slice_06",
      "date": "2025-12-27",
      "title": "Dashboard compile fixes",
      "summary": [
        "Fixed missing imports and removed references to non-existent Settings screen.",
        "Reduced warning churn by removing unused declarations."
      ],
      "files": {
        "modified": [
          "app/unitana/lib/features/dashboard/dashboard_screen.dart",
          "app/unitana/lib/features/first_run/first_run_screen.dart"
        ],
        "added": [],
        "removed": []
      }
    },
    {
      "id": "slice_07",
      "date": "2025-12-27",
      "title": "Analyzer cleanup: remove withOpacity deprecations",
      "summary": [
        "Replaced deprecated withOpacity calls to satisfy flutter analyze."
      ],
      "files": {
        "modified": [
          "app/unitana/lib/features/dashboard/dashboard_screen.dart"
        ],
        "added": [],
        "removed": []
      }
    },
    {
      "id": "slice_08",
      "date": "2025-12-27",
      "title": "Context database and slice template",
      "summary": [
        "Added docs/ai/context_db.json as the durable context source for new chats.",
        "Added docs/ai/SLICE_TEMPLATE.md and basic docs indexing and revision history conventions."
      ],
      "files": {
        "modified": [],
        "added": [
          "docs/ai/context_db.json",
          "docs/ai/SLICE_TEMPLATE.md",
          "docs/README.md",
          "docs/ai/README.md",
          "docs/ai/REVISION_HISTORY_CONVENTION.md"
        ],
        "removed": []
      }
    },
    {
      "id": "slice_09",
      "date": "2025-12-27",
      "title": "Wizard visual polish and profile-first copy",
      "summary": [
        "Refined first-run wizard typography using Shadows Into Light for selected headers and the profile name.",
        "Adjusted intro slide spacing and reinforced the profile badge (flag emoji) in onboarding and dashboard."
      ],
      "files": {
        "modified": [
          "app/unitana/lib/features/first_run/first_run_screen.dart",
          "app/unitana/lib/features/dashboard/dashboard_screen.dart",
          "app/unitana/pubspec.yaml"
        ],
        "added": [],
        "removed": []
      }
    },
    {
      "id": "slice_10",
      "date": "2025-12-27",
      "title": "Test selector and compile fixes",
      "summary": [
        "Fixed widget tests by using ValueKey selectors for wizard navigation and step keys.",
        "Cleaned up dashboard compile issues introduced during UI iteration."
      ],
      "files": {
        "modified": [
          "app/unitana/test/widget_test.dart",
          "app/unitana/test/app_smoke_test.dart",
          "app/unitana/lib/features/dashboard/dashboard_screen.dart"
        ],
        "added": [],
        "removed": []
      }
    },
    {
      "id": "slice_11",
      "date": "2025-12-27",
      "title": "Regression tests and docs IA hardening",
      "summary": [
        "Added regression widget tests focused on small-screen overflow prevention (dashboard and first-run review).",
        "Added shared test helpers to capture framework errors like RenderFlex overflow.",
        "Updated docs IA and links; added docs/testing.md; updated AI workflow docs and the context database."
      ],
      "files": {
        "modified": [
          "README.md",
          "docs/README.md",
          "docs/ai/README.md",
          "docs/ai/WORKING_WITH_CHATGPT.md",
          "docs/ai/context_db.json"
        ],
        "added": [
          "docs/testing.md",
          "app/unitana/test/test_utils.dart",
          "app/unitana/test/dashboard_regression_test.dart",
          "app/unitana/test/first_run_review_regression_test.dart"
        ],
        "removed": []
      }
    },
    {
      "id": "slice_12",
      "date": "2025-12-27",
      "title": "README banner typo fix",
      "intent": "Fix UNITANA ASCII header spelling in README.",
      "changed_files": [
        "README.md"
      ],
      "added_files": [],
      "removed_files": [],
      "verification": [
        "dart format .",
        "flutter analyze",
        "flutter test"
      ],
      "notes": [
        "No runtime impact; documentation-only."
      ]
    },
    {
      "id": "slice_13",
      "date": "2025-12-27",
      "title": "Places Hero tile refactor attempt, compile break, and rollback to stable baseline",
      "status": "rolled_back",
      "summary": [
        "Attempted to replace the existing dashboard Destination/Home tiles with a new full-width Places Hero widget and segmented toggle behavior.",
        "Implementation diverged from existing models and widget APIs (null-safety mismatches, missing imports/types, and constructor parameter drift), causing flutter analyze and widget tests to fail.",
        "Rolled back to the last known-good baseline where the app boots and tests pass; preserved learnings via retro/postmortem and updated the AI context DB so the next chat can restart safely."
      ],
      "artifacts": {
        "failed_patch_zips": [
          "unitana_patch_sev1_restore_places_hero_tile_2025-12-27.zip",
          "unitana_patch_sev1_places_hero_tile_compile_fix_2025-12-27.zip"
        ],
        "reference_images": [
          "Screenshot 2025-12-27 at 9.38.45 PM.png",
          "ChatGPT Image Dec 27, 2025, 10_56_06 PM.png"
        ]
      },
      "primary_failures": [
        "Null-safety contract drift (PlacesHeroSelection? passed where PlacesHeroSelection required).",
        "Invented or missing domain types (UnitSystem) and helper methods (_formatTime) not wired to existing code.",
        "Constructor signatures and named parameters out of sync (prefersMetric, localLabel/homeLabel/isCompact; required parameters missing).",
        "Duplicate named parameters and deprecated APIs introduced during rapid iteration."
      ],
      "lessons_learned": [
        "Snapshot and preserve public widget APIs (constructors, required params, typedefs) until the integration pass; avoid opportunistic API edits mid-stream.",
        "Treat any new domain enum or model as a cross-cutting change that requires an explicit plan and an import audit; do not invent types that are not already in the codebase.",
        "Keep analysis green at micro-steps (flutter analyze frequently), then run flutter test at checkpoints; stop when either gate fails.",
        "Prefer parallel implementation: add new widgets alongside old and switch usage behind a small toggle; avoid replacing the dashboard in one pass.",
        "Record recurring failure modes (null-safety, API drift, invented types) as hard workflow rules for future chats."
      ],
      "next_actions": [
        "Write a SEV-1 style postmortem for the failed Places Hero attempt and define a safer re-implementation plan (parallel widget plus feature flag).",
        "Update docs/ai/WORKING_WITH_CHATGPT.md with hard rules for null-safety, constructor drift, and import/type verification.",
        "Regenerate NEXT_CHAT_HANDOFF and NEXT_CHAT_PROMPT so the next implementation chat starts from the stable baseline but includes the aspirational mock and acceptance criteria."
      ]
    },
    {
      "id": "slice_14",
      "date": "2025-12-29",
      "title": "Dashboard grid: add-slots and tool picker",
      "summary": [
        "Keep Places Hero as the first, anchored grid tile (it still scrolls with the dashboard).",
        "Render \"+\" placeholders for unoccupied grid cells so the layout reads as extendable.",
        "Tapping any \"+\" opens a lightweight tool picker; selecting a tool opens the existing tool modal."
      ],
      "files_modified": [
        "app/unitana/lib/features/dashboard/widgets/dashboard_board.dart",
        "docs/ai/context_db.json"
      ],
      "notes": {
        "grid_behavior": [
          "The board pads to a minimum row count (phone vs wide layouts) so a few empty \"+\" slots are always visible.",
          "Empty cells are computed from placed tile spans (including hero), then rendered as add tiles."
        ],
        "tool_picker": [
          "Tool picker lists ToolDefinitions.all (currently: Distance, Baking, Liquids, Area).",
          "Selection forwards into ToolModalBottomSheet.show() using the active reality's unit preference."
        ]
      }
    },
    {
      "id": "slice_15",
      "date": "2025-12-29",
      "title": "Dashboard grid: compile stabilization + green tests",
      "summary": [
        "Resolved a chain of compile failures introduced while iterating on the dense grid + placeholder slots implementation.",
        "Aligned internal placement helpers with current model types (tile span, placed cells, and lens/tool metadata).",
        "Reached a green state: `flutter test` passes; `flutter analyze` reports only informational lints."
      ],
      "files_modified": [
        "app/unitana/lib/features/dashboard/widgets/dashboard_board.dart",
        "docs/ai/context_db.json"
      ],
      "notes": {
        "final_state": [
          "Analyzer infos remaining: `use_build_context_synchronously` in the tool-picker open flow; `withOpacity` deprecation warnings.",
          "These are explicitly deferred; do not treat as build breakers."
        ],
        "why_it_broke": [
          "During the refactor, several helper names/types drifted (e.g., placement helper fields like `cells`, `rowSpan`, `colSpan`, and lens IDs as nullable vs non-nullable).",
          "Switch exhaustiveness checks flagged new enum values until placeholder handling was made explicit."
        ],
        "followups": [
          "Make the picker insertion real (persist chosen tool into the board layout) instead of immediately launching the tool modal.",
          "Consider extracting `_ToolPickerSheet` into its own file for testability and reuse (optional refactor)."
        ]
      }
    },
    {
      "id": "slice_16",
      "date": "2025-12-30",
      "title": "Dashboard grid: restore missing layout constants",
      "summary": [
        "Fixed a compile/test breaker caused by referencing removed layout constants in `DashboardBoard` (`_gap`, `_tileHeightRatio`, `_minRowsPhone`, `_minRowsTablet`).",
        "Centralized the constants as top-level tuning knobs to avoid future drift and make density changes straightforward."
      ],
      "files_modified": [
        "app/unitana/lib/features/dashboard/widgets/dashboard_board.dart",
        "docs/ai/context_db.json"
      ],
      "notes": {
        "why_it_broke": [
          "During iterative grid refactors, layout constants were referenced from `_DashboardBoardState` but not defined in file scope, so analyzer and tests failed at compile time."
        ],
        "verification": [
          "dart format .",
          "flutter analyze",
          "flutter test"
        ],
        "followups": [
          "Treat tablet support as a separate effort; keep breakpoints conservative until tablet UI/UX is scoped."
        ]
      }
    }
  ],
  "current_pain_points": [
    "Small-tile layout constraints on small iPhones (about 147x147).",
    "Avoiding fragile copy that triggers overflows.",
    "Avoiding null assertions on theme extensions.",
    "Keeping flutter analyze clean to reduce churn.",
    "Small-surface layout overflows (RenderFlex) in dashboard hero/AppBar must be treated as test failures.",
    "Parent-derived compact flags can disagree with child constraints; prefer LayoutBuilder within fixed-height widgets.",
    "Dependency constraint drift remains parked for a sustaining engineering slice."
  ],
  "next_backlog": [
    {
      "id": "slice_13b_places_hero_v2",
      "title": "Implement Places Hero v2 on dashboard",
      "type": "implementation",
      "status": "shipped",
      "branch": "main",
      "baseline": {
        "commit": "f5c6464",
        "tag": "baseline-2025-12-27"
      },
      "owner_roles": [
        "Product & Strategy Lead",
        "UI/UX Lead",
        "Mobile Engineering Lead",
        "QA & Release Lead",
        "Senior Technical Writer",
        "AI Workflow/Prompt Engineer"
      ],
      "acceptance_criteria": [
        "Places Hero replaces Destination/Home tiles and uses a single segmented toggle to swap primary place (Lisbon vs Denver).",
        "Top-left circular refresh button triggers refresh for all network-backed data used by the hero (weather, currency, etc.) and is debounced.",
        "Weather icon in hero is slightly larger and inset from the right edge; no 'two dots' artifact on Denver segment; Denver label is right-aligned.",
        "Tool tiles (Height, Baking, Liquids, Area) open a shared bottom sheet modal with inputs on top and a last-10 history log at bottom; most recent item is larger/bold; tapping history reloads.",
        "flutter analyze and flutter test pass; widget tests cover toggle, refresh, modal, and history behavior.",
        "Regression: no RenderFlex overflows on small phone surfaces; treat overflows as test failures."
      ],
      "notes": [
        "Prefer parallel widget approach initially; avoid changing existing public widget constructors until integration is proven.",
        "Avoid introducing new domain types unless explicitly planned and wired through imports.",
        "Keep Dracula theme tokens consistent across hero, tiles, and modal.",
        "Roadmap correction (2025-12-30): DashboardBoard + ToolModalBottomSheet already implement scrollable grid, placeholders, tool picker, and input+history modals. Next slices focus on default layout seeding, theme audit, and dependency drift."
      ],
      "deliverables": [
        "Patch zip with full revised files and list of added/removed files",
        "Updated widget/regression tests for the new dashboard layout",
        "Updated docs/ai/NEXT_CHAT_PROMPT.md and handoff as needed"
      ]
    },
    {
      "id": "slice_13e_seed_default_dashboard_layout",
      "title": "Seed default dashboard tiles on first run (4 default tools)",
      "type": "implementation",
      "status": "planned",
      "branch": "feat/dashboard-default-layout",
      "owner_roles": [
        "Product & Strategy Lead",
        "Mobile Engineering Lead",
        "QA & Release Lead"
      ],
      "acceptance_criteria": [
        "When no saved layout exists, dashboard seeds 4 default tool tiles (Height, Baking, Liquids, Area) into the first available grid slots.",
        "Seed runs once and does not overwrite a user-customized layout.",
        "Widget tests cover first-run seeding and persistence; analyze + tests green.",
        "No layout overflows on small phone surfaces."
      ],
      "notes": [
        "Prefer implementing seeding inside DashboardLayoutController.ensureLoaded() or adjacent init path; keep public widget APIs stable.",
        "Use stable keys for tiles to keep existing tests resilient."
      ],
      "deliverables": [
        "Patch zip with code + test updates",
        "docs/ai/context_db.json patch_tracking entry"
      ]
    },
    {
      "id": "slice_14_dracula_theme_audit",
      "title": "Dracula theme audit head-to-toe (typography + roles)",
      "type": "design+implementation",
      "status": "planned",
      "branch": "feat/theme-audit",
      "owner_roles": [
        "UI/UX Lead",
        "Mobile Engineering Lead",
        "QA & Release Lead"
      ],
      "acceptance_criteria": [
        "All screens reviewed for text roles (title, body, muted, chip labels) using Dracula tokens consistently.",
        "No hard-coded colors outside theme extensions unless explicitly justified.",
        "Golden tests or widget tests updated where needed; analyze + tests green."
      ],
      "notes": [
        "Keep contrast accessible; prefer theme extensions in lib/theme/theme_extensions.dart."
      ],
      "deliverables": [
        "Patch zip with theme changes + test updates",
        "Updated AI docs noting role mapping decisions"
      ]
    },
    {
      "id": "slice_15_dependency_drift_resolution",
      "title": "Resolve dependency constraint drift (pubspec hygiene)",
      "type": "sustaining",
      "status": "planned",
      "branch": "chore/dependency-drift",
      "owner_roles": [
        "Mobile Engineering Lead",
        "QA & Release Lead"
      ],
      "acceptance_criteria": [
        "flutter pub outdated reviewed and constraints updated where safe.",
        "No breaking changes; analyze + tests green.",
        "Patch includes brief changelog of dependency deltas."
      ],
      "notes": [
        "Do not bump Flutter SDK constraints unless required; keep changes minimal and well explained."
      ],
      "deliverables": [
        "Patch zip",
        "docs/ai/context_db.json patch_tracking entry"
      ]
    },
    {
      "id": "slice_13",
      "title": "Dashboard redesign design spec (new chat)",
      "type": "design_only",
      "status": "planned",
      "owner_roles": [
        "Product & Strategy Lead",
        "UI/UX Lead",
        "Mobile Engineering Lead",
        "QA & Release Lead",
        "Senior Technical Writer",
        "AI Workflow/Prompt Engineer"
      ],
      "deliverables": [
        "Two alternative layouts for a profile-first dashboard (Places tile + tools)",
        "Chosen layout with breakpoint rules (2/3/4 columns), copy hierarchy, accessibility notes",
        "Implementation plan split into 2–4 small slices with acceptance criteria and verification commands",
        "Identify doc/context updates needed during implementation"
      ],
      "notes": [
        "Run as a fresh chat; attach repo zip plus docs/ai/context_db.json and the Slice 13 prompt file."
      ]
    },
    {
      "id": "docs_ia_pass",
      "title": "Docs information architecture pass",
      "notes": [
        "Ensure /docs structure is coherent.",
        "Ensure READMEs match their directories.",
        "Adopt a simple revision history convention."
      ]
    },
    {
      "id": "context_db_growth",
      "title": "Expand context_db with stable decisions",
      "notes": [
        "Add new slice entries as part of each patch note.",
        "Add design token references and key widget keys as they stabilize.",
        "Keep a short \"known gotchas\" list with links to fixes."
      ]
    },
    "Roadmap (approved): Mobile-complete → Polish → Onboarding v2 → Tablet",
    "Finish core mobile tool functionality first (working, not fully polished).",
    "Run a focused UI/UX polish sprint: visual coherence, interaction refinement, and performance/cleanup, plus AI-process retro improvements.",
    "Spike: Onboarding wizard v2 design to match the finished dashboard aesthetic (believable sample values, add an education slide for calculator tools, explain dashboard editing, default first-4 widgets).",
    "Execute: Onboarding wizard v2 updates.",
    "Spike: Tablet experience scope (layouts, orientations, dashboard grid, tool modals, menus, onboarding).",
    "Execute: Tablet support."
  ],
  "last_updated": "2025-12-30",
  "patch_tracking": {
    "policy": {
      "require_context_db_update_per_patch": true,
      "require_patch_log_entry_per_patch": true,
      "patch_log_location": "docs/ai/context_db.json -> patch_tracking.log",
      "patch_bundle_requirements": [
        "Include all changed files",
        "Include updated docs/ai/context_db.json",
        "If UI changes: add/update a screenshot or doc in docs/ (or note why not)",
        "If tests updated: ensure flutter test passes locally"
      ],
      "key_stability_rule": "If widget keys are used in tests, keep keys stable across refactors; never duplicate a key on multiple widgets."
    },
    "log": [
      {
        "patch_id": "2025-12-28c",
        "date": "2025-12-28",
        "artifact": "unitana_patch_compile_fix_dashboard_menu_and_unitsystem_2025-12-28c.zip",
        "summary": "compile fix dashboard menu and unitsystem",
        "source": "assistant_patch_zip"
      },
      {
        "patch_id": "2025-12-28",
        "date": "2025-12-28",
        "artifact": "unitana_patch_dashboard_live_data_fix3_2025-12-28.zip",
        "summary": "dashboard live data fix3",
        "source": "assistant_patch_zip"
      },
      {
        "patch_id": "2025-12-28",
        "date": "2025-12-28",
        "artifact": "unitana_patch_dashboard_overflow_and_test_fix_2025-12-28.zip",
        "summary": "dashboard overflow and test fix",
        "source": "assistant_patch_zip"
      },
      {
        "patch_id": "2025-12-28",
        "date": "2025-12-28",
        "artifact": "unitana_patch_dashboard_smoke_right_overflow_fix_2025-12-28.zip",
        "summary": "dashboard smoke right overflow fix",
        "source": "assistant_patch_zip"
      },
      {
        "patch_id": "2025-12-28",
        "date": "2025-12-28",
        "artifact": "unitana_patch_dashboard_smoke_test_fix_2025-12-28.zip",
        "summary": "dashboard smoke test fix",
        "source": "assistant_patch_zip"
      },
      {
        "patch_id": "2025-12-28",
        "date": "2025-12-28",
        "artifact": "unitana_patch_dashboard_smoke_test_update_2025-12-28.zip",
        "summary": "dashboard smoke test update",
        "source": "assistant_patch_zip"
      },
      {
        "patch_id": "2025-12-29e",
        "date": "2025-12-29",
        "artifact": "unitana_patch_docs_consolidation_ai_tooling_2025-12-29e.zip",
        "summary": "docs consolidation ai tooling",
        "source": "assistant_patch_zip"
      },
      {
        "patch_id": "2025-12-28",
        "date": "2025-12-28",
        "artifact": "unitana_patch_docs_slice13b_prompt_capture_2025-12-28.zip",
        "summary": "docs slice13b prompt capture",
        "source": "assistant_patch_zip"
      },
      {
        "patch_id": "2025-12-28a",
        "date": "2025-12-28",
        "artifact": "unitana_patch_incremental_ui_polish_2025-12-28a.zip",
        "summary": "incremental ui polish",
        "source": "assistant_patch_zip"
      },
      {
        "patch_id": "2025-12-28",
        "date": "2025-12-28",
        "artifact": "unitana_patch_overflow_fixes_2025-12-28.zip",
        "summary": "overflow fixes",
        "source": "assistant_patch_zip"
      },
      {
        "patch_id": "2025-12-28",
        "date": "2025-12-28",
        "artifact": "unitana_patch_places_hero_v2_2025-12-28.zip",
        "summary": "places hero v2",
        "source": "assistant_patch_zip"
      },
      {
        "patch_id": "2025-12-28",
        "date": "2025-12-28",
        "artifact": "unitana_patch_places_hero_v2_fix2_2025-12-28.zip",
        "summary": "places hero v2 fix2",
        "source": "assistant_patch_zip"
      },
      {
        "patch_id": "2025-12-28",
        "date": "2025-12-28",
        "artifact": "unitana_patch_places_hero_v2_fix_2025-12-28.zip",
        "summary": "places hero v2 fix",
        "source": "assistant_patch_zip"
      },
      {
        "patch_id": "2025-12-28d",
        "date": "2025-12-28",
        "artifact": "unitana_patch_restore_dashboard_v2_keyfix_2025-12-28d.zip",
        "summary": "restore dashboard v2 keyfix",
        "source": "assistant_patch_zip"
      },
      {
        "patch_id": "2025-12-29",
        "date": "2025-12-29",
        "artifact": "unitana_patch_stability_plus_postmortem_and_next_prompt_2025-12-29.zip",
        "summary": "stability plus postmortem and next prompt",
        "source": "assistant_patch_zip"
      },
      {
        "patch_id": "2025-12-28",
        "date": "2025-12-28",
        "artifact": "unitana_patch_three_files_compile_fix_2025-12-28.zip",
        "summary": "three files compile fix",
        "source": "assistant_patch_zip"
      },
      {
        "patch_id": "2025-12-28b",
        "date": "2025-12-28",
        "artifact": "unitana_patch_weather_icon_wind_polish_2025-12-28b.zip",
        "summary": "weather icon wind polish",
        "source": "assistant_patch_zip"
      },
      {
        "patch_id": "2025-12-29f",
        "date": "2025-12-29",
        "source": "chatgpt",
        "artifact": "unitana_patch_fix_dashboard_board_modal_2025-12-29.zip",
        "summary": "Dashboard board + tool modal wiring: align tool tiles with canonical tool registry, ensure modal bottom sheet supports calculator + history panel layout, and tighten dashboard board placement behavior for default tools."
      },
      {
        "patch_id": "2025-12-29g",
        "date": "2025-12-29",
        "source": "chatgpt",
        "artifact": "unitana_patch_fix_dashboard_board_item_2025-12-29.zip",
        "summary": "Dashboard board item model fix: introduce explicit item ids, item kind mapping, and tile span metadata; update board code to use these primitives and map tool ids to tool definitions consistently."
      },
      {
        "patch_id": "2025-12-29h",
        "date": "2025-12-29",
        "source": "chatgpt",
        "artifact": "unitana_patch_fix_tests_pumpandsettle_2025-12-29.zip",
        "summary": "Test stability: replace pumpAndSettle usage in dashboard widget tests with bounded pumping to avoid animation/timer hangs; keep intent assertions the same."
      },
      {
        "patch_id": "2025-12-29i",
        "date": "2025-12-29",
        "source": "chatgpt",
        "artifact": "lint_cleanup_dashboard_smoke_import_2025-12-29",
        "summary": "Lint cleanup: remove redundant flutter/material import from dashboard_smoke_test to silence unused_import warning."
      },
      {
        "patch_id": "2025-12-29j",
        "date": "2025-12-29",
        "source": "chatgpt",
        "artifact": "unitana_patch_dashboard_grid_add_slots_2025-12-29j.zip",
        "summary": "Dashboard grid UX: keep Places Hero as the anchored first tile (still scrollable), render \"+\" placeholders for empty grid cells, and add an in-grid tool picker that opens existing tool modals."
      },
      {
        "patch_id": "2025-12-29k",
        "date": "2025-12-29",
        "source": "chatgpt",
        "artifact": "unitana_patch_fix_dashboard_grid_compile_2025-12-29k.zip",
        "summary": "Fix dashboard grid compilation after adding empty slots and dense placement (switch exhaustiveness, type alignment, and null-safety touchups)."
      },
      {
        "patch_id": "2025-12-29l",
        "date": "2025-12-29",
        "source": "chatgpt",
        "artifact": "unitana_patch_fix_dashboard_board_placeholders_compile_2025-12-29l.zip",
        "summary": "Stabilize placeholder rendering and tool picker wiring; remove/avoid model mismatches introduced during the grid refactor."
      },
      {
        "patch_id": "2025-12-29m",
        "date": "2025-12-29",
        "source": "chatgpt",
        "artifact": "unitana_patch_fix_dashboard_board_align_models_2025-12-29m.zip",
        "summary": "Align DashboardBoard placement helpers with current models; resolve missing type/enum and helper method mismatches."
      },
      {
        "patch_id": "2025-12-29n",
        "date": "2025-12-29",
        "source": "chatgpt",
        "artifact": "unitana_patch_fix_dashboard_board_compile_2025-12-29n.zip",
        "summary": "Iterative compile fixes for dashboard_board.dart (placement helper fields, lens selection defaults, and null-safety for lens IDs)."
      },
      {
        "patch_id": "2025-12-29o",
        "date": "2025-12-29",
        "source": "chatgpt",
        "artifact": "unitana_patch_fix_dashboard_board_compile_2025-12-29o.zip",
        "summary": "Finalize placement helper API alignment (rowSpan/colSpan naming) so tests compile and run."
      },
      {
        "patch_id": "2025-12-29p",
        "date": "2025-12-29",
        "source": "chatgpt",
        "artifact": "unitana_patch_fix_dashboard_board_compile_2025-12-29p.zip",
        "summary": "Green build: flutter test passes; only analyzer info warnings remain (use_build_context_synchronously, withOpacity deprecation)."
      },
      {
        "patch_id": "2025-12-30f",
        "date": "2025-12-30",
        "artifact": "unitana_patch_fix_longpress_remove_test_visibility_2025-12-30f.zip",
        "summary": "Stabilize dashboard long-press remove test by ensuring tile is visible and long-pressing an inner label to avoid hit-test warnings in scrollable grid.",
        "source": "assistant_patch_zip"
      },
      {
        "patch_id": "2025-12-30g",
        "date": "2025-12-30",
        "artifact": "unitana_patch_dashboard_edit_mode_scaffold_2025-12-30g.zip",
        "summary": "Add dashboard widget edit mode scaffold: menu entry + long-press enters edit mode, Done/Cancel commit or revert via layout draft buffering, inline remove badges with confirmation, and reset/restart now clears persisted dashboard layout.",
        "source": "assistant_patch_zip"
      },
      {
        "patch_id": "2025-12-30i",
        "date": "2025-12-30",
        "artifact": "unitana_patch_app_icon_and_tile_overflow_fix_2025-12-30.zip",
        "summary": "Set Unitana app icon from unitana_logo.png across Android/iOS/macOS/web; tighten UnitanaTile layout for micro tiles to prevent RenderFlex overflow on small phones.",
        "source": "chatgpt"
      },
      {
        "patch_id": "2025-12-30j",
        "date": "2025-12-30",
        "title": "Fix small-surface overflows + wrap-up docs",
        "summary": "Fix AppBar leading overflow by constraining width; remove unused import and redundant null assertion; replace deprecated withOpacity usage; make Places Hero left block choose compact layout based on its own constraints (LayoutBuilder); add retro, lessons, and next chat prompt/handoff docs.",
        "artifact": "unitana_patch_wrapup_layout_overflow_and_ai_docs_2025-12-30.zip",
        "changed_files": [
          "app/unitana/lib/features/dashboard/dashboard_screen.dart",
          "app/unitana/lib/features/dashboard/widgets/places_hero_v2.dart",
          "docs/ai/context_db.json",
          "docs/ai/WORKING_WITH_CHATGPT.md",
          "docs/ai/RETRO_2025-12-30.md",
          "docs/ai/CHAT_LESSONS_2025-12-30.json",
          "docs/ai/NEXT_CHAT_PROMPT.md",
          "docs/ai/NEXT_CHAT_PROMPT_2025-12-30.md",
          "docs/ai/NEXT_CHAT_HANDOFF_2025-12-30.md"
        ]
      },
      {
        "id": "patch_2025-12-30k_fix_refresh_and_visual_density",
        "title": "Fix: refresh wiring + slightly reduce visual density",
        "summary": [
          "Adjust Places Hero refresh flow and clean up dashboard visual density.",
          "Keep tests green after refresh button changes."
        ],
        "changed_files": [
          "app/unitana/lib/features/dashboard/dashboard_screen.dart",
          "app/unitana/lib/features/dashboard/widgets/places_hero_v2.dart",
          "docs/ai/context_db.json"
        ],
        "artifact": "unitana_patch_fix_refresh_and_visual_density_2025-12-30k.zip",
        "issue_tags": [
          "layout",
          "dashboard",
          "refresh"
        ]
      },
      {
        "id": "patch_2025-12-30l_fix_appbar_overflow_and_context_guard",
        "title": "Fix: AppBar leading overflow + async context guard",
        "summary": [
          "Eliminate AppBar leading RenderFlex overflow on small surfaces.",
          "Avoid BuildContext use across async gaps (mounted checks aligned)."
        ],
        "changed_files": [
          "app/unitana/lib/features/dashboard/dashboard_screen.dart",
          "docs/ai/context_db.json"
        ],
        "artifact": "unitana_patch_fix_appbar_overflow_and_context_guard_2025-12-30l.zip",
        "issue_tags": [
          "layout",
          "appbar",
          "analyzer"
        ]
      },
      {
        "id": "patch_2025-12-30m_docs_roadmap_correction",
        "title": "Docs: correct roadmap (grid + tool modals already shipped)",
        "summary": [
          "Update NEXT_CHAT_HANDOFF and NEXT_CHAT_PROMPT to reflect that DashboardBoard, tool picker, and tool modals already exist.",
          "Correct next slices: default layout seeding, Dracula theme audit, dependency drift.",
          "Add a process lesson: scan codebase before writing the next roadmap/prompt."
        ],
        "changed_files": [
          "docs/ai/NEXT_CHAT_HANDOFF_2025-12-30.md",
          "docs/ai/NEXT_CHAT_PROMPT.md",
          "docs/ai/CHAT_LESSONS_2025-12-30.json",
          "docs/ai/context_db.json"
        ],
        "artifact": "unitana_patch_docs_roadmap_correction_2025-12-30m.zip",
        "issue_tags": [
          "ai-docs",
          "roadmap"
        ]
      }
    ]
  },
  "docs_taxonomy": {
    "docs_root": "docs/",
    "ui_assets": {
      "preferred_folders": [
        "docs/wireframes",
        "docs/design",
        "docs/screenshots"
      ],
      "naming": "YYYY-MM-DD_slug_platform_context_vNN.ext (example: 2025-12-29_dashboard_places-hero_ios_v2.png)",
      "rules": [
        "Avoid dumping screenshots in root; file by intent (wireframe/design/screenshot).",
        "Prefer one screenshot per change, but only when it clarifies behavior.",
        "When consolidating, preserve original filenames in git history via move/rename rather than copy."
      ]
    },
    "postmortems": {
      "folder": "docs/postmortems/",
      "naming": "YYYY-MM-DD_short-title.md",
      "rules": [
        "Keep one incident per file.",
        "Cross-link to patch_id(s) in patch_tracking.log."
      ]
    }
  },
  "patch_history": [
    {
      "patch_id": "2025-12-31b",
      "title": "Places Hero currency: fix arg drift and null-safety for live rates",
      "artifact": "unitana_patch_fix_places_hero_currency_args_2025-12-31b.zip",
      "scope": [
        "app/unitana/lib/features/dashboard/widgets/places_hero_v2.dart",
        "docs/ai/context_db.json",
        "docs/ai/CHAT_LESSONS_2025-12-31.json",
        "docs/ai/AI_DOCS_INDEX.md"
      ],
      "notes": [
        "Removed unused EUR→GBP and EUR→CAD parameters and getters that were never implemented on DashboardLiveDataController.",
        "Currency lines now tolerate missing live data by falling back to a sane default rate, keeping the hero non-empty while APIs warm up.",
        "Added docs/ai/AI_DOCS_INDEX.md so the assistant has a single, stable entry point for doc ingestion and handoffs.",
        "Current live-rate support remains focused on EUR↔USD; other currency pairs render as placeholders until we add a generalized rates model."
      ]
    },
    {
      "patch_id": "2025-12-31a",
      "title": "Dashboard hero: remove internal refresh; always show wind/currency in compact layout",
      "artifact": "unitana_patch_remove_hero_refresh_and_show_wind_currency_2025-12-31a.zip",
      "scope": [
        "app/unitana/lib/features/dashboard/widgets/places_hero_v2.dart",
        "docs/ai/context_db.json",
        "docs/ai/CHAT_LESSONS_2025-12-31.json",
        "docs/ai/WORKING_WITH_CHATGPT.md"
      ],
      "notes": [
        "Removed the Places Hero in-widget refresh button; use the dashboard-level refresh instead.",
        "Compact hero layout now shows wind and currency info (with placeholders when data is missing), matching the non-compact experience.",
        "Documented canonical locations for AI context so handoffs are easier to ingest."
      ]
    },
    {
      "id": "2025-12-30m",
      "title": "Docs roadmap correction",
      "artifact": "unitana_patch_docs_roadmap_correction_2025-12-30m.zip"
    }
  ]
}
