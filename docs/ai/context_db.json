{
  "backlog": [
    {
      "id": "radio_lofi_playback",
      "title": "Radio: license-free lo-fi playback (default OFF)",
      "summary": "Optional ambient lo-fi playback feature. Default OFF; when OFF, do not start any network/audio session/background work.",
      "notes": [
        "Later: onboarding wizard mention + Settings toggle.",
        "Default OFF is non-negotiable for MVP; zero background work when OFF."
      ]
    }
  ],
  "current_state": {
    "notes": [
      "Build green through Slice O12g3 (WeatherAPI wiring + SceneKey binding in progress; marquee label is live).",
      "ToolPicker is opened from the top-left tools icon; Quick Tools lens removed; Most Recent + Search remain.",
      "Default tiles are removable and persist; restoring a removed default via picker restores it without duplicates.",
      "Dashboard tiles inherit per-tool tint and per-lens accent mapping.",
      "Places Hero V2: clocks first; header format locked; sun pill present; wind and gust split; text scales down (no ellipsis).",
      "iOS app icon visibility remains backlog only.",
      "Weather MVP decision: WeatherAPI.com provider; map condition codes -> SceneKey catalog (docs/ai/reference/SCENEKEY_CATALOG.md).",
      "Next slice: O12g4 live SceneKey mapping/binding (WeatherAPI code -> SceneKey -> marquee), then continue O12f family scene redesign."
    ],
    "status": "green"
  },
  "decisions": [
    {
      "date": "2026-01-02",
      "topic": "Weather provider MVP",
      "decision": "Use WeatherAPI.com for MVP weather provider; map WeatherAPI condition codes to provider-agnostic SceneKeys.",
      "rationale": "WeatherAPI provides a clear condition-code list and predictable pricing; we can keep requests low via caching and on-demand refresh."
    },
    {
      "date": "2026-01-02",
      "topic": "Hero weather visuals",
      "decision": "Adopt a SceneKey catalog with day/night variation driven by the hero location toggle (sun/moon time-based).",
      "rationale": "Separates art from provider logic, keeps tests deterministic, and ensures consistent visuals across future providers."
    }
  ],
  "design_system": {
    "notes": [
      "Audit text styles across pages for contrast and hierarchy."
    ],
    "theme": "Dracula-inspired"
  },
  "file_map": {
    "context_db": "docs/ai/context_db.json",
    "handoff": "docs/ai/handoff/CURRENT_HANDOFF.md",
    "next_prompt": "docs/ai/prompts/NEXT_CHAT_PROMPT.md",
    "places_hero_v2": "app/unitana/lib/features/dashboard/widgets/places_hero_v2.dart",
    "workflow": "docs/ai/reference/WORKFLOW.md"
  },
  "ground_rules": [
    "Every code change must include a docs/ai patch note entry (patch_id, summary, files_changed).",
    "Keep docs/ai small and canonical: avoid duplicate prompts and parallel copies.",
    "Prefer updating existing canonical files over creating new variants."
  ],
  "last_updated": "2026-01-09",
  "patch_log": [
    {
      "date": "2025-12-31",
      "files_changed": [
        "app/unitana/test/dashboard_tool_insertion_persistence_test.dart",
        "docs/ai/context_db.json"
      ],
      "id": "patch_2025-12-31_sliceH_hotfix_tests_scroll_scope",
      "notes": {
        "reason": "ToolPickerSheet now includes additional top content (most recent + search), and the app surface contains multiple scrollables during modal tests.",
        "risk": "Low; test-only behavior change."
      },
      "slice": "H",
      "summary": [
        "Updated dashboard tool insertion/removal widget tests to pass an explicit scrollable Finder to scrollUntilVisible().",
        "Scoped scrolling to the modal BottomSheet's Scrollable to avoid 'Too many elements' errors when multiple scrollables exist (dashboard grid + bottom sheet list)."
      ],
      "title": "Tests: scope ToolPicker scrollUntilVisible to bottom sheet scrollable"
    },
    {
      "date": "2025-12-31",
      "files_changed": [
        "app/unitana/lib/features/dashboard/models/activity_lenses.dart",
        "app/unitana/lib/features/dashboard/models/tool_registry.dart",
        "app/unitana/lib/features/dashboard/models/dashboard_session_controller.dart",
        "app/unitana/lib/features/dashboard/models/tool_definitions.dart",
        "app/unitana/lib/features/dashboard/widgets/dashboard_board.dart",
        "app/unitana/test/dashboard_places_hero_v2_test.dart",
        "app/unitana/test/dashboard_tool_insertion_persistence_test.dart",
        "docs/ai/context_db.json"
      ],
      "id": "patch_2025-12-31_sliceC_toolpicker_2level",
      "notes": [
        "Slice B (Places Hero polish) remains complete; Slice D (AI docs workflow) is now reflected via this patch log entry.",
        "iOS icon visibility remains backlog-only per constraints."
      ],
      "slice": "C",
      "summary": [
        "Implemented a collapsible, two-level ToolPickerSheet that lists Activity Lenses first and tools within each lens (ordered per spec).",
        "Added stable keys: lens headers use toolpicker_lens_<lensId>, tool rows use toolpicker_tool_<toolId>.",
        "Introduced ToolRegistry (dedup-first) to encode the canonical lens/tool inventory and ordering, including Quick Tools sections (Favorites placeholder, Recents from session, Odd-but-useful static list).",
        "Aligned Activity Lens IDs to the canonical spec (with backwards-compatible aliases) and updated the Height tile labeling.",
        "Updated widget tests to expand the Home and DIY lens before selecting Area from the picker."
      ],
      "title": "ToolPickerSheet: two-level hierarchy (Activity Lenses -> Tools)"
    },
    {
      "date": "2025-12-31",
      "files_changed": [
        "app/unitana/lib/features/dashboard/models/dashboard_board_item.dart",
        "app/unitana/lib/features/dashboard/models/dashboard_layout_controller.dart",
        "app/unitana/lib/features/dashboard/models/tool_definitions.dart",
        "app/unitana/lib/features/dashboard/models/tool_registry.dart",
        "app/unitana/lib/features/dashboard/widgets/dashboard_board.dart",
        "app/unitana/lib/features/dashboard/widgets/tool_modal_bottom_sheet.dart",
        "docs/ai/handoff/CURRENT_HANDOFF.md"
      ],
      "id": "patch_2025-12-31_sliceF_G_bundle1",
      "summary": [
        "Introduced generic tool tiles keyed by toolId (DashboardItemKind.tool) and added migration from legacy tool kinds.",
        "Enabled Bundle 1 tools (Distance, Speed, Temperature) end-to-end: tool registry -> picker -> tile -> modal -> history.",
        "Tool picker now prefers direct ToolDefinition lookup by toolId, reducing future work to adding definitions.",
        "Conversion history is now keyed by ToolDefinition.id (separate histories per user-facing tool), while canonicalToolId remains the conversion engine key."
      ],
      "title": "Dashboard tool tiles: toolId-based persistence + Bundle 1 tools"
    },
    {
      "date": "2025-12-31",
      "files_changed": [
        "app/unitana/test/dashboard_places_hero_v2_test.dart",
        "docs/ai/context_db.json"
      ],
      "id": "patch_2025-12-31_sliceF_G_hotfix_tests",
      "summary": [
        "Updated Places Hero V2 widget test expectations to align with toolId-owned result/history keys (baking vs liquids).",
        "Confirmed Liquids and Baking maintain distinct user-facing histories even when sharing a canonical conversion engine."
      ],
      "title": "Test fix: tool modal result/history keys use user-facing tool IDs"
    },
    {
      "date": "2025-12-31",
      "files_changed": [
        "app/unitana/test/dashboard_places_hero_v2_test.dart",
        "docs/ai/context_db.json"
      ],
      "id": "patch_2025-12-31_testfix_placeshero_default_tiles",
      "summary": [
        "Updated Places Hero V2 widget test to assert the current default dashboard tiles (Height, Baking, Liquids, Area) rather than Distance.",
        "Distance remains an enabled tool in the registry but is not part of ToolDefinitions.defaultTiles."
      ],
      "title": "Test fix: Places Hero V2 default tile assertions (Height/Baking/Liquids/Area)"
    },
    {
      "date": "2025-12-31",
      "files_changed": [
        "app/unitana/lib/features/dashboard/widgets/dashboard_board.dart",
        "app/unitana/test/dashboard_tool_insertion_persistence_test.dart",
        "docs/ai/context_db.json",
        "docs/ai/handoff/CURRENT_HANDOFF.md",
        "docs/ai/prompts/NEXT_CHAT_PROMPT.md"
      ],
      "id": "patch_2025-12-31_sliceH_toolpicker_search_accordion",
      "summary": [
        "Removed the Favorites section from Quick Tools (no pinned/star workflow).",
        "Added a most-recent tool shortcut at the top of the picker plus a search field that filters tool rows.",
        "Changed lens sections to a single-expanded accordion: expanding one lens collapses the others.",
        "Kept stable keys for lens headers and tool rows to preserve persistence and tests."
      ],
      "title": "Tool picker UX: search, recent shortcut, and single-expanded lens"
    },
    {
      "date": "2025-12-31",
      "files_changed": [
        "app/unitana/test/dashboard_tool_insertion_persistence_test.dart"
      ],
      "id": "patch_2025-12-31_sliceH_hotfix_toolpicker_tests",
      "notes": {
        "reason": "ToolPicker lens headers and tool rows may be off-screen in tests after adding search + most-recent section and accordion behavior.",
        "risk": "Low; test-only change."
      },
      "slice": "H-hotfix",
      "summary": [
        "Fixed dashboard tool insertion/removal widget tests for the Slice H ToolPicker accordion by scrolling lens headers and tool rows into view before tapping.",
        "Replaced ensureVisible() on tool rows (which requires an already-built element) with scrollUntilVisible() to handle lazily-built list items."
      ]
    },
    {
      "date": "2025-12-31",
      "files_changed": [
        "app/unitana/lib/theme/dracula_palette.dart",
        "app/unitana/lib/theme/app_theme.dart",
        "app/unitana/lib/features/dashboard/models/lens_accents.dart",
        "app/unitana/lib/features/dashboard/widgets/dashboard_board.dart",
        "docs/ai/context_db.json",
        "docs/ai/handoff/CURRENT_HANDOFF.md",
        "docs/ai/prompts/NEXT_CHAT_PROMPT.md"
      ],
      "id": "patch_2025-12-31_sliceI_lens_accent_colors",
      "slice": "I",
      "summary": [
        "Introduced canonical DraculaPalette constants and LensAccents mapping (lensId -> accent).",
        "Tinted ToolPicker lens headers and tool row icons by lens accent for clearer hierarchy without changing text contrast.",
        "Refactored app theme to reference DraculaPalette constants (single source of truth for palette hex values)."
      ],
      "title": "Lens accent colors: Dracula palette tinting for ToolPicker icons"
    },
    {
      "date": "2025-12-31",
      "files_changed": [
        "app/unitana/lib/features/dashboard/models/numeric_input_policy.dart",
        "app/unitana/lib/features/dashboard/widgets/tool_modal_bottom_sheet.dart",
        "app/unitana/lib/features/dashboard/widgets/unitana_tile.dart",
        "docs/ai/context_db.json",
        "docs/ai/handoff/CURRENT_HANDOFF.md",
        "docs/ai/prompts/NEXT_CHAT_PROMPT.md"
      ],
      "id": "patch_2025-12-31_sliceJ_numeric_limits_overflow",
      "slice": "J",
      "summary": [
        "Added a shared NumericInputPolicy and NumericTextInputFormatter for tool calculator fields.",
        "Applied per-tool digit policies (tightened for height, temperature, and area) and allowed freeform ft/in inputs for Height in imperial direction.",
        "Updated dashboard tiles to scale down primary/secondary values instead of truncating with ellipsis."
      ],
      "title": "Numeric input limits and scale-down value rendering to prevent overflow"
    },
    {
      "date": "2025-12-31",
      "files_changed": [
        "app/unitana/lib/features/dashboard/widgets/tool_modal_bottom_sheet.dart",
        "docs/ai/context_db.json"
      ],
      "id": "patch_2025-12-31_sliceJ_hotfix_remove_unused_freeformInput",
      "slice": "J",
      "summary": [
        "Removed an unused private getter in ToolModalBottomSheet after consolidating freeform-input behavior under _requiresFreeformInput."
      ],
      "title": "Hotfix: remove unused freeformInput helper to keep analyze clean"
    },
    {
      "date": "2025-12-31",
      "files_changed": [
        "app/unitana/lib/features/dashboard/widgets/dashboard_board.dart",
        "app/unitana/lib/features/dashboard/models/tool_registry.dart",
        "app/unitana/lib/features/dashboard/models/tool_definitions.dart",
        "docs/ai/context_db.json",
        "docs/ai/handoff/CURRENT_HANDOFF.md",
        "docs/ai/prompts/NEXT_CHAT_PROMPT.md"
      ],
      "id": "patch_2025-12-31_sliceK_tool_search_results_weight_tools",
      "notes": [
        "Search results use keys toolpicker_search_tool_<toolId> to avoid collisions with tool rows.",
        "Weight conversion is kg <-> lb; separate user-facing tool IDs share the canonical weight engine per the dedup-first rule."
      ],
      "slice": "K",
      "summary": [
        "ToolPicker search now surfaces an immediate Results section and auto-expands the first matching lens when typing.",
        "Enabled Weight (Food) and Body weight (Health) tools end-to-end (ToolRegistry isEnabled + ToolDefinitions + converters)."
      ],
      "title": "ToolPicker search results + enable Weight tools"
    },
    {
      "date": "2025-12-31",
      "files_changed": [
        "app/unitana/lib/features/dashboard/models/activity_lenses.dart",
        "docs/ai/context_db.json",
        "docs/ai/handoff/CURRENT_HANDOFF.md",
        "docs/ai/prompts/NEXT_CHAT_PROMPT.md"
      ],
      "id": "patch_2025-12-31_sliceK_hotfix_activity_lenses_by_id",
      "notes": [
        "Fixes compile/analyze failure: ActivityLenses.byId referenced from dashboard_board.dart search results subtitle."
      ],
      "slice": "K",
      "summary": [
        "Adds ActivityLenses.byId(String) so ToolPicker search results can render the primary lens name without introducing new dependencies."
      ],
      "title": "Hotfix: add ActivityLenses.byId lookup"
    },
    {
      "date": "2025-12-31",
      "files_changed": [
        "app/unitana/lib/features/dashboard/models/tool_definitions.dart",
        "app/unitana/lib/features/dashboard/widgets/tool_modal_bottom_sheet.dart",
        "app/unitana/lib/features/dashboard/widgets/dashboard_board.dart",
        "docs/ai/context_db.json",
        "docs/ai/handoff/CURRENT_HANDOFF.md",
        "docs/ai/prompts/NEXT_CHAT_PROMPT.md"
      ],
      "id": "patch_2025-12-31_sliceL_weight_modal_units",
      "notes": [
        "Addresses UX inconsistency discovered after enabling Weight tools in Slice K."
      ],
      "slice": "L",
      "summary": [
        "Fixed Weight tool modal labeling and unit toggling to match existing tool patterns (e.g., Temperature shows C → F or F → C).",
        "Corrected Weight conversion display so inputs/outputs clearly indicate kg ↔ lb; removed ambiguous \"what/lbs\" presentation.",
        "Ensured Weight tool tile subtitle uses the correct unit pair string and stays consistent with other tiles."
      ],
      "title": "Weight tool: consistent unit labels + modal header clarity"
    },
    {
      "date": "2026-01-01",
      "files_changed": [
        "app/unitana/lib/features/dashboard/widgets/dashboard_board.dart",
        "app/unitana/lib/features/dashboard/widgets/tool_modal_bottom_sheet.dart",
        "app/unitana/lib/features/dashboard/dashboard_screen.dart",
        "app/unitana/lib/features/dashboard/models/dashboard_layout_controller.dart",
        "app/unitana/test/dashboard_tool_insertion_persistence_test.dart",
        "docs/ai/context_db.json",
        "docs/ai/handoff/CURRENT_HANDOFF.md",
        "docs/ai/prompts/NEXT_CHAT_PROMPT.md"
      ],
      "id": "patch_2026-01-01_sliceM_tools_run_and_add_widget",
      "notes": [
        "Slice M included a hotfix chain to restore stability; final state is green."
      ],
      "slice": "M",
      "summary": [
        "Changed ToolPicker behavior so selecting a tool runs it immediately (opens its modal) rather than implicitly adding a dashboard tile.",
        "Added an explicit \"+ Add Widget\" action in tool modals for users who want to pin the tool to the dashboard.",
        "Updated dashboard/controller wiring so adding a widget uses the canonical toolId registry and preserves stable keys and persistence."
      ],
      "title": "Tools menu: run tools without adding; explicit Add Widget flow"
    },
    {
      "date": "2026-01-01",
      "files_changed": [
        "app/unitana/lib/features/dashboard/models/activity_lenses.dart",
        "app/unitana/lib/features/dashboard/models/tool_registry.dart",
        "app/unitana/lib/features/dashboard/models/lens_accents.dart",
        "app/unitana/test/tool_lens_map_test.dart",
        "docs/ai/context_db.json",
        "docs/ai/handoff/CURRENT_HANDOFF.md",
        "docs/ai/prompts/NEXT_CHAT_PROMPT.md"
      ],
      "id": "patch_2026-01-01_sliceN_odd_but_useful_top_level_lens",
      "notes": [
        "Follow-up requested: choose an accent clearly distinct from Home and DIY if any contrast concerns appear."
      ],
      "slice": "N",
      "summary": [
        "Promoted \"Odd But Useful\" to a first-class Activity Lens with its own stable lensId and Dracula accent color.",
        "Kept dedup-first rule: tools remain single toolIds; lens membership is an entry-point context only.",
        "Updated ToolRegistry/ActivityLenses mapping and tests to include the new lens."
      ],
      "title": "Odd But Useful: promoted to top-level lens"
    },
    {
      "date": "2026-01-01",
      "files_changed": [
        "app/unitana/lib/features/dashboard/widgets/tool_modal_bottom_sheet.dart",
        "app/unitana/lib/features/dashboard/dashboard_screen.dart",
        "app/unitana/test/add_widget_confirmation_test.dart",
        "docs/ai/context_db.json"
      ],
      "id": "patch_2026-01-01_sliceO1_add_widget_confirmation_visible",
      "notes": {
        "risk": "Low; changes are localized to tool modal UI and one callback.",
        "ux": "Confirmation is rendered inside the tool bottom sheet so it remains visible even when the modal is open."
      },
      "slice": "O1",
      "summary": [
        "Replaced the modal-obscured Add Widget SnackBar with an in-modal confirmation row that stays visible while the bottom sheet is open.",
        "Auto-dismisses the confirmation after a short delay and keeps stable keys for UI tests.",
        "Removed the redundant dashboard-level SnackBar from the Add Widget callback to avoid hidden or double notifications."
      ],
      "title": "Tool modal: visible confirmation for Add Widget"
    },
    {
      "date": "2026-01-01",
      "files_changed": [
        "app/unitana/lib/features/dashboard/widgets/tool_modal_bottom_sheet.dart",
        "app/unitana/lib/features/dashboard/widgets/dashboard_board.dart",
        "app/unitana/test/add_widget_confirmation_test.dart",
        "docs/ai/context_db.json"
      ],
      "id": "patch_2026-01-01_sliceO1b_add_widget_confirmation_banner",
      "notes": {
        "risk": "Low; only affects confirmation UI and adds small timers that cancel on dispose.",
        "ux": "MaterialBanner renders at the top of the root Scaffold, so it remains visible while bottom sheets are open."
      },
      "slice": "O1",
      "summary": [
        "Added a top-of-screen MaterialBanner confirmation (auto-dismiss) when a widget is added, ensuring the feedback stays visible even while a bottom sheet is open.",
        "Kept the in-modal confirmation row, providing redundant visibility in case the user scrolls or misses one cue.",
        "Converted the dashboard tool-add confirmation from a bottom SnackBar to the same banner pattern to avoid modal occlusion."
      ],
      "title": "Add Widget confirmation: visible banner fallback"
    },
    {
      "date": "2026-01-01",
      "details": [
        "Removed Add Widget top MaterialBanner that could be obscured by the modal; keep a visible in-modal notice.",
        "Introduced UnitanaToast overlay (root overlay) for consistent transient confirmations/errors.",
        "Migrated dashboard confirmations (add tool, replace/remove tile, refresh/update) to UnitanaToast.",
        "Converted invalid modal input feedback to inline notice (no hidden SnackBars)."
      ],
      "files_changed": [
        "app/unitana/lib/common/feedback/unitana_toast.dart",
        "app/unitana/lib/common/widgets/unitana_notice_card.dart",
        "app/unitana/lib/features/dashboard/widgets/tool_modal_bottom_sheet.dart",
        "app/unitana/lib/features/dashboard/widgets/dashboard_board.dart",
        "app/unitana/lib/features/dashboard/dashboard_screen.dart",
        "app/unitana/test/add_widget_confirmation_test.dart"
      ],
      "id": "patch_2026-01-01_slice_O1c_toast_notifications",
      "summary": "Replace hidden scaffold banners/snackbars with consistent toast + inline modal notices"
    },
    {
      "date": "2026-01-01",
      "files_changed": [
        "app/unitana/lib/common/widgets/unitana_notice_card.dart",
        "app/unitana/lib/common/feedback/unitana_toast.dart",
        "app/unitana/lib/features/dashboard/widgets/tool_modal_bottom_sheet.dart",
        "app/unitana/lib/features/dashboard/widgets/dashboard_board.dart",
        "app/unitana/lib/features/dashboard/dashboard_screen.dart",
        "app/unitana/test/add_widget_confirmation_test.dart",
        "docs/ai/context_db.json",
        "docs/ai/handoff/CURRENT_HANDOFF.md"
      ],
      "id": "patch_2026-01-01_sliceO1c_unified_confirmations_toast_notice",
      "notes": {
        "follow_up": "O1c1 hotfix corrects a NoticeCard import path and removes an analyzer warning in UnitanaToast.",
        "ux": "Modals show inline notice; screens use the same toast surface for transient confirmations."
      },
      "slice": "O1",
      "summary": [
        "Replaced modal-hidden SnackBar confirmations with an in-modal UnitanaNoticeCard that stays visible while the bottom sheet is open.",
        "Introduced UnitanaToast (root overlay) for consistent transient confirmations across the app, using Dracula-friendly surfaces and contrast-first typography.",
        "Updated dashboard confirmations to use the same feedback pattern for cohesive messaging."
      ],
      "title": "Confirmations: unify UX with toast + in-modal notice"
    },
    {
      "date": "2026-01-01",
      "files_changed": [
        "app/unitana/lib/features/dashboard/widgets/tool_modal_bottom_sheet.dart",
        "app/unitana/lib/common/feedback/unitana_toast.dart",
        "docs/ai/context_db.json",
        "docs/ai/handoff/CURRENT_HANDOFF.md"
      ],
      "id": "patch_2026-01-01_sliceO1c1_fix_notice_import_and_toast_overlay",
      "notes": {
        "qa": "Run flutter analyze and flutter test; confirm Add Widget notice is visible without collapsing the sheet.",
        "risk": "Low; import path + overlay lookup only."
      },
      "slice": "O1",
      "summary": [
        "Fixed ToolModalBottomSheet to import UnitanaNoticeCard from the correct common path (avoids lib/features/common/... lookup).",
        "Switched UnitanaToast overlay lookup to Overlay.maybeOf(...) to resolve unnecessary_null_comparison and keep safe early-return behavior.",
        "Restores flutter analyze cleanliness and unblocks flutter test compilation."
      ],
      "title": "Fix O1c: correct notice import + toast overlay warning"
    },
    {
      "date": "2026-01-01",
      "files_changed": [
        "app/unitana/lib/common/feedback/unitana_toast.dart",
        "docs/ai/context_db.json",
        "docs/ai/handoff/CURRENT_HANDOFF.md"
      ],
      "id": "patch_2026-01-01_sliceO1c2_toast_offset_below_appbar",
      "notes": {
        "qa": "Re-run dashboard_tool_insertion_persistence_test; Dashboard edit Done should be tappable while a toast is visible.",
        "ux": "Toast remains at the top of the screen but sits below the AppBar; tap-to-dismiss preserved."
      },
      "slice": "O1",
      "summary": [
        "Moved UnitanaToast positioning below the toolbar (kToolbarHeight + padding) so confirmations don't obstruct AppBar actions like Dashboard edit Done/Cancel.",
        "Prevents test flakiness where overlay hit-testing could miss AppBar taps while a toast is visible."
      ],
      "title": "Fix O1c: toast no longer blocks AppBar actions"
    },
    {
      "date": "2026-01-01",
      "files_changed": [
        "app/unitana/lib/features/dashboard/widgets/unitana_tile.dart",
        "app/unitana/lib/features/dashboard/widgets/dashboard_board.dart",
        "app/unitana/test/dashboard_tile_icon_accent_test.dart",
        "docs/ai/context_db.json",
        "docs/ai/handoff/CURRENT_HANDOFF.md"
      ],
      "id": "patch_2026-01-01_sliceO2_dashboard_tiles_inherit_icon_accent",
      "notes": {
        "risk": "Low; change is additive (optional param) and localized to dashboard tile rendering.",
        "ux": "Tiles now visually match picker iconography and lens accent system; Odd But Useful lens uses its distinct accent automatically."
      },
      "slice": "O2",
      "summary": [
        "Updated dashboard tiles to color their leading icon and footer cue using the owning tool’s Activity Lens accent (Dracula palette tints), eliminating the legacy global purple accent.",
        "Added an optional accentColor override to UnitanaTile, allowing per-tool coloring while keeping existing defaults when no override is provided.",
        "Added a widget test asserting the Height tile uses the Health & Fitness lens accent for both icon and footer cue (covers Odd But Useful mapping via the same path)."
      ],
      "title": "Dashboard tiles: inherit tool icon + lens accent"
    },
    {
      "date": "2026-01-01",
      "files_changed": [
        "app/unitana/lib/features/dashboard/dashboard_screen.dart",
        "app/unitana/test/add_widget_confirmation_test.dart",
        "docs/ai/context_db.json",
        "docs/ai/handoff/CURRENT_HANDOFF.md"
      ],
      "id": "patch_2026-01-01_sliceO3_dashboard_tools_button_remove_refresh",
      "notes": {
        "qa": "Run flutter analyze and flutter test; verify top-left button opens Tools picker and no refresh action is exposed on dashboard.",
        "risk": "Low; localized dashboard AppBar change + test update.",
        "ux": "Tools is a higher-frequency action than manual refresh; this reduces top-level UI competition and improves discoverability."
      },
      "slice": "O3",
      "summary": [
        "Replaced the dashboard AppBar leading refresh control with a Tools button (4-box icon) that opens the ToolPickerSheet.",
        "Removed dashboard-level manual refresh wiring; keep live-data refresh as roadmap work and per-tool refresh for live data.",
        "Added a widget test asserting the Tools button opens the ToolPickerSheet."
      ],
      "title": "Dashboard: replace refresh button with Tools launcher; remove manual refresh"
    },
    {
      "changes": [
        "Quick Tools lens is no longer included in the ToolPickerSheet accordion; discovery flows rely on Most Recent + Search + top-level lenses.",
        "ActivityLensId.quickTools remains as a stable constant for backwards compatibility, but is excluded from canonical lens ordering.",
        "Added widget test to ensure Quick Tools lens is absent while search continues to function."
      ],
      "date": "2026-01-01",
      "files": [
        "app/unitana/lib/features/dashboard/models/activity_lenses.dart",
        "app/unitana/lib/features/dashboard/widgets/dashboard_board.dart",
        "app/unitana/test/toolpicker_quick_tools_removed_test.dart",
        "docs/ai/context_db.json",
        "docs/ai/handoff/CURRENT_HANDOFF.md"
      ],
      "id": "patch_2026-01-01_slice_O4_remove_quick_tools_lens",
      "notes": [
        "No public widget API changes; stable IDs preserved."
      ],
      "slice": "O4",
      "title": "Remove Quick Tools lens from picker accordion"
    },
    {
      "changes": [
        "Dashboard now blocks adding a widget when that tool already exists on the dashboard (includes default tiles and user-added tiles).",
        "Duplicate attempts show consistent error feedback (UnitanaToast for dashboard picker; UnitanaNoticeCard error inside tool modals).",
        "Updated persistence tests to add a non-default tool and verify duplicates are prevented."
      ],
      "date": "2026-01-01",
      "files": [
        "app/unitana/lib/features/dashboard/dashboard_screen.dart",
        "app/unitana/lib/features/dashboard/widgets/dashboard_board.dart",
        "app/unitana/lib/features/dashboard/widgets/tool_modal_bottom_sheet.dart",
        "app/unitana/lib/features/dashboard/models/dashboard_exceptions.dart",
        "app/unitana/test/dashboard_tool_insertion_persistence_test.dart",
        "docs/ai/context_db.json",
        "docs/ai/handoff/CURRENT_HANDOFF.md"
      ],
      "id": "patch_2026-01-01_slice_O5_prevent_duplicate_widgets",
      "notes": [
        "No public widget API changes; stable IDs preserved.",
        "Replacement flow also prevents selecting a tool already present elsewhere on the dashboard."
      ],
      "slice": "O5",
      "title": "Prevent duplicate dashboard widgets"
    },
    {
      "changes": [
        "Default dashboard tiles (Height, Baking, Liquids, Area, etc.) can be removed in edit mode using the same affordances as user-added tiles.",
        "Removing a default tile persists via a hidden-default list; adding that tool again restores the default tile instead of creating a duplicate.",
        "Added widget test coverage for removing a default tile and restoring it via picker search."
      ],
      "date": "2026-01-01",
      "files": [
        "app/unitana/lib/features/dashboard/widgets/dashboard_board.dart",
        "app/unitana/test/dashboard_tool_insertion_persistence_test.dart",
        "docs/ai/context_db.json",
        "docs/ai/handoff/CURRENT_HANDOFF.md"
      ],
      "id": "patch_2026-01-01_slice_O6_remove_default_tiles",
      "notes": [
        "No public widget API churn; stable tool IDs remain the persistence keys.",
        "Hidden default tracking is designed so future changes to the default set can be applied by recomputing ToolDefinitions.defaultTiles while preserving user intent (hidden vs visible)."
      ],
      "slice": "O6",
      "title": "Allow removing default dashboard tiles"
    },
    {
      "areas": [
        "dashboard",
        "persistence",
        "tests"
      ],
      "constraints_respected": [
        "no public widget API churn",
        "stable IDs/keys",
        "dracula palette restrained"
      ],
      "date": "2026-01-01",
      "id": "patch_2026-01-01_slice_O6b_hidden_default_key_compat",
      "slice": "O6b",
      "summary": "Write hidden-default state to dashboard_hidden_defaults_v1 while continuing to read/write the legacy key to preserve existing installs and keep tests stable.",
      "test_status": "flutter analyze clean; flutter test passing (expected after patch)",
      "title": "Hidden default tile persistence key compatibility"
    },
    {
      "areas": [
        "dashboard",
        "persistence",
        "ui",
        "tests"
      ],
      "constraints_respected": [
        "no public widget API churn",
        "stable IDs/keys",
        "dracula palette restrained"
      ],
      "date": "2026-01-01",
      "id": "patch_2026-01-01_slice_O7_reset_dashboard_defaults",
      "slice": "O7",
      "summary": "Add a dashboard menu action that restores the current default tile set derived from ToolDefinitions.defaultTiles by clearing user-added tiles, layout edits, and the hidden-default state so removed defaults return.",
      "test_status": "flutter analyze clean; flutter test passing (expected after patch)",
      "title": "Reset Dashboard Defaults menu action"
    },
    {
      "areas": [
        "dashboard",
        "places_hero",
        "menu",
        "tests",
        "persistence"
      ],
      "constraints_respected": [
        "no public widget API churn",
        "stable IDs/keys",
        "dracula palette restrained"
      ],
      "date": "2026-01-01",
      "id": "patch_2026-01-01_slice_O7h_hotfix_layout_reset_and_hero_header",
      "slice": "O7h",
      "summary": "Fix Reset Dashboard Defaults implementation issues (controller API + test seeding) and remove the redundant “Tools” entry from the top-right menu now that a dedicated tools button exists. Restore the Places Hero V2 clock header to the two-line centered format using bullets, and center the “Sunrise / Sunset” header within its pill.",
      "test_status": "flutter analyze clean; flutter test passing (expected after patch)",
      "title": "Hotfix: Reset defaults wiring + hero header formatting"
    },
    {
      "date": "2026-01-01",
      "files_changed": [
        "unitana/app/unitana/lib/features/dashboard/dashboard_screen.dart",
        "unitana/app/unitana/lib/features/dashboard/models/dashboard_layout_controller.dart",
        "unitana/app/unitana/lib/features/dashboard/widgets/places_hero_v2.dart",
        "unitana/app/unitana/test/dashboard_reset_defaults_test.dart"
      ],
      "id": "patch_2026-01-01_slice_O7h_hotfix_reset_defaults_and_hero_header",
      "slice": "O7h",
      "summary": "Addresses regressions from the O7 reset-defaults slice by ensuring the DashboardLayoutController exposes resetDashboardDefaults(), fixing the widget test to seed layout JSON using the current schema, and removing the redundant “Tools” option from the top-right (...) menu since a dedicated Tools button now exists. Also restores the PlacesHeroV2 time header to the two-line centered format: “Lisbon • Denver +7h” and “01:03 WET • 6:03 PM MST (Fri 2 Jan)”, and centers the “Sunrise / Sunset” title within its pill.",
      "title": "Hotfix: Reset defaults + hero time header"
    },
    {
      "date": "2026-01-01",
      "files_changed": [
        "lib/features/dashboard/models/dashboard_layout_controller.dart"
      ],
      "id": "patch_2026-01-01_slice_O7i_hotfix_hidden_defaults_reset_race",
      "notes": {
        "reason": "Widget tests showed hidden-default prefs sometimes remained after reset due to async load/reset ordering.",
        "risk": "Low; load becomes no-op if reset occurs during its async window."
      },
      "slice": "O7",
      "summary": [
        "Added an epoch token to DashboardLayoutController to invalidate in-flight load() when clear/reset runs.",
        "Reset Dashboard Defaults now reliably clears hidden-default state in memory and SharedPreferences, preventing stale state from reappearing in tests or after rapid UI actions."
      ],
      "tests": [
        "test/dashboard_reset_defaults_test.dart"
      ],
      "title": "Hotfix: invalidate in-flight load during reset so hidden-default prefs fully clear"
    },
    {
      "date": "2026-01-01",
      "files_changed": [
        "app/unitana/lib/features/dashboard/models/dashboard_layout_controller.dart",
        "docs/ai/context_db.json"
      ],
      "id": "patch_2026-01-01_sliceO7_hotfix_store_hidden_defaults",
      "slice": "O7",
      "summary": [
        "Added missing private helper _storeHiddenDefaults in DashboardLayoutController.",
        "Ensures legacy StringList hidden-default prefs are migrated to canonical JSON-string storage without analyzer/test failures."
      ],
      "title": "Hotfix: define _storeHiddenDefaults to complete hidden-default migration"
    },
    {
      "date": "2026-01-01",
      "files_changed": [
        "docs/ui/PLACES_HERO_V2_SPEC.md",
        "docs/ui/DASHBOARD_SPEC.md",
        "docs/ui/README.md",
        "docs/ai/handoff/CURRENT_HANDOFF.md",
        "docs/ai/prompts/NEXT_CHAT_PROMPT.md",
        "docs/ai/context_db.json"
      ],
      "id": "patch_2026-01-01_sliceP0_design_spec_stabilization",
      "slice": "P0",
      "summary": [
        "Added canonical UI specs for Places Hero V2 and dashboard behavior to reduce regressions.",
        "Documented locked clock header format, sun pill rules, wind/gust formatting, and the reserved marquee slot constraints.",
        "Updated canonical handoff and next-chat prompt to make the documentation slice the immediate next step."
      ],
      "title": "Docs: stabilize Places Hero V2 and dashboard specs"
    },
    {
      "date": "2026-01-01",
      "files_changed": [
        "app/unitana/lib/features/dashboard/widgets/places_hero_v2.dart",
        "app/unitana/test/dashboard_places_hero_v2_test.dart",
        "docs/ai/context_db.json",
        "docs/ai/handoff/CURRENT_HANDOFF.md",
        "docs/ai/prompts/NEXT_CHAT_PROMPT.md",
        "docs/ai/prompts/NEXT_CHAT_PROMPT_SENIOR_REVIEW.md",
        "docs/ui/PLACES_HERO_V2_SPEC.md"
      ],
      "id": "patch_2026-01-01_sliceO7n_hero_label_emphasis",
      "slice": "O7n",
      "summary": [
        "Sunrise/Sunset pill title now centers within the pill width (scale-down preserved).",
        "Emphasized key row labels for scanability: Wind, Gust, Sunrise, Sunset, and Rate (higher contrast + heavier weight).",
        "Updated widget tests to tolerate RichText rows and updated the Places Hero V2 spec to match."
      ],
      "title": "Places Hero V2: emphasize labels and center sun title"
    },
    {
      "id": "patch_2026-01-01_sliceO7o_analyzer_clean_places_hero",
      "date": "2026-01-01",
      "slice": "O7o",
      "title": "Places Hero V2: analyzer cleanup (no behavior change)",
      "summary": [
        "Removed unused private widget parameters that triggered analyzer warnings.",
        "Renamed local helper closures to satisfy lint rules (no leading underscores for locals).",
        "Kept existing keys and text output stable to avoid test and persistence regressions."
      ],
      "files_changed": [
        "app/unitana/lib/features/dashboard/widgets/places_hero_v2.dart",
        "docs/ai/context_db.json"
      ]
    },
    {
      "id": "patch_2026-01-01_sliceR1_tile_footer_convert_cta",
      "date": "2026-01-01",
      "slice": "R1",
      "title": "Dashboard tiles: Convert CTA + conversion icon",
      "summary": [
        "Replaced the dashboard tile footer copy from “Tap to convert” to “Convert”.",
        "Swapped the footer dot indicator for a conversion icon (swap_horiz) and centered the CTA row.",
        "Updated widget tests to assert the new footer text and icon tinting behavior."
      ],
      "files_changed": [
        "app/unitana/lib/features/dashboard/widgets/dashboard_board.dart",
        "app/unitana/lib/features/dashboard/widgets/unitana_tile.dart",
        "app/unitana/test/dashboard_smoke_test.dart",
        "app/unitana/test/dashboard_tile_icon_accent_test.dart",
        "docs/ai/context_db.json",
        "docs/ai/handoff/CURRENT_HANDOFF.md"
      ]
    },
    {
      "id": "O12d2a-docs-weatherapi-scenekey-catalog",
      "date": "2026-01-02",
      "summary": [
        "Documented SceneKey catalog for hero marquee weather scenes, including full WeatherAPI code mapping and revised SMOKE_WILDFIRE concept.",
        "Updated CURRENT_HANDOFF with shipped slice summary, WeatherAPI MVP decision, SceneKey policy, and next-slice breakdown (O12e/O12f/O12g).",
        "Updated senior review next-chat prompt to enforce smaller slices and focus the next slice on Developer Tools Weather overflow hardening."
      ],
      "files": [
        "docs/ai/reference/SCENEKEY_CATALOG.md",
        "docs/ai/handoff/CURRENT_HANDOFF.md",
        "docs/ai/prompts/NEXT_CHAT_PROMPT_SENIOR_REVIEW.md",
        "docs/ai/context_db.json"
      ]
    },
    {
      "id": "patch_2026-01-03_docs_handoff_refresh_senior_transition",
      "date": "2026-01-03",
      "slice": "DOCS",
      "title": "Handoff refresh + senior transition prompt (post O12g3 stabilization)",
      "summary": [
        "Refreshed CURRENT_HANDOFF to reflect O12e–O12g3 outcomes, current priorities, risks, and lessons learned.",
        "Set next slice definition for O12g4 (WeatherAPI condition.code -> SceneKey -> marquee selection, DevTools override precedence).",
        "Prepared senior-team transition prompt for next chat to reduce scope thrash and enforce one-slice execution."
      ],
      "files_changed": [
        "docs/ai/handoff/CURRENT_HANDOFF.md",
        "docs/ai/prompts/NEXT_CHAT_PROMPT_SENIOR_REVIEW.md",
        "docs/ai/context_db.json"
      ]
    },
    {
      "id": "patch_2026-01-05_o12j10_tool_modal_terminal_typography",
      "date": "2026-01-05",
      "slice": "O12j10",
      "title": "Tool modal terminal polish (monospace prompt, remove $ prefix, timestamp styling)",
      "summary": [
        "Strengthened Dracula-terminal feel in tool modals: consistent monospace typography, prompt glyph styling, and improved readability.",
        "Removed all \"$\" prompt prefixes to avoid currency confusion; standardized prompt to \"❯\".",
        "Improved microcopy and affordances: dynamic \"Enter Value\" -> \"Edit Value\" when input present; timestamp rendered as lighter italic meta text."
      ],
      "files_changed": [
        "lib/features/dashboard/widgets/tool_modal_bottom_sheet.dart"
      ]
    },
    {
      "id": "patch_2026-01-08_o12k07g_time_tool_test_toolpicker_selection",
      "date": "2026-01-08",
      "slice": "O12k07g",
      "title": "Time modal test: robust ToolPicker selection + direction-aware input",
      "summary": [
        "Fixes brittle test coupling to the exact 'Time' label by selecting the first enabled ToolPicker search result whose title contains 'time' (case-insensitive).",
        "Derives toolId from modal keys (tool_input_*) and chooses 12h vs 24h input based on the modal '<from> → <to>' direction label.",
        "Validates conversion output shape plus history tap-to-copy and long-press-to-edit behaviors without relying on list ordering."
      ],
      "files_changed": [
        "test/time_tool_modal_interaction_test.dart"
      ]
    },
    {
      "id": "patch_2026-01-09_o12k13d_header_button_equal_size_and_platform_icon_audit",
      "date": "2026-01-09",
      "slice": "O12k13d",
      "title": "Dashboard header: equal-size mirrored buttons + platform icon audit doc",
      "summary": [
        "Makes the top-left Tools and top-right Menu buttons true mirrors by using a shared header icon button widget with identical size, border, and edge insets.",
        "Adds a lightweight cross-platform launcher icon audit checklist under docs/ai/reference to reduce platform-specific icon regressions."
      ],
      "files_changed": [
        "app/unitana/lib/features/dashboard/dashboard_screen.dart",
        "docs/ai/reference/PLATFORM_ICON_AUDIT.md"
      ]
    },
    {
      "id": "patch_2026-01-09_o12k13e_fix_duplicate_devtools_clock_override",
      "date": "2026-01-09",
      "slice": "O12k13e",
      "title": "Fix duplicate DevTools clock override symbols (debugClockOffset)",
      "summary": [
        "Fixes analyzer/test failures caused by duplicate definitions of debugClockOffset and setDebugClockOffset in dashboard_live_data.dart.",
        "Clarifies clock override comment as a simulator-only offset (not NTP, not backend sync, not timezone reconfiguration)."
      ],
      "files_changed": [
        "app/unitana/lib/features/dashboard/models/dashboard_live_data.dart",
        "docs/ai/context_db.json",
        "docs/ai/handoff/CURRENT_HANDOFF.md"
      ]
    },
    {
      "id": "patch_2026-01-09_o12k13f_stabilize_time_tool_modal_test",
      "date": "2026-01-09",
      "slice": "O12k13f",
      "title": "Stabilize time tool modal widget test",
      "summary": [
        "Updates time_tool_modal_interaction_test.dart to prefer ToolPicker search (toolpicker_search + toolpicker_search_tool_time) instead of relying on lens headers ordering/presence.",
        "Adds fallback paths (direct row, lens expansion, scroll) with a clearer failure message if the ToolPicker contract keys are missing."
      ],
      "files_changed": [
        "app/unitana/test/time_tool_modal_interaction_test.dart",
        "docs/ai/context_db.json",
        "docs/ai/handoff/CURRENT_HANDOFF.md"
      ]
    },
    {
      "id": "patch_2026-01-09_o12k13g_add_devtools_clock_override_ui",
      "date": "2026-01-09",
      "slice": "O12k13g",
      "title": "Add DevTools clock override UI (keys + sheet)",
      "summary": [
        "Adds a Clock Override entry to the Developer Tools sheet (key: devtools_clock_menu) and a dedicated sheet with an enable toggle + offset slider.",
        "Wires the UI to DashboardLiveDataController.setDebugClockOffset so Places Hero time displays can be adjusted for simulator testing without NTP or backend sync."
      ],
      "files_changed": [
        "app/unitana/lib/features/dashboard/dashboard_screen.dart",
        "docs/ai/context_db.json",
        "docs/ai/handoff/CURRENT_HANDOFF.md"
      ]
    },
    {
      "date": "2026-01-09",
      "id": "patch_2026-01-09_O12k13h_sev1_recovery_dashboard_parse_header_mirror",
      "slice": "O12k13h",
      "title": "Sev 1 recovery: DashboardScreen parse fix + mirrored header button size guard",
      "summary": [
        "Fixed a broken/mismatched bracket/brace sequence in DashboardScreen AppBar menu bottom sheet, restoring clean parsing/formatting.",
        "Confirmed Tools (top-left) and Menu (top-right) header buttons remain true mirrors by keeping sizing centralized in _HeaderIconButton.",
        "Added a widget test that asserts dashboard_tools_button and dashboard_menu_button render at identical sizes."
      ],
      "files_changed": [
        "app/unitana/lib/features/dashboard/dashboard_screen.dart",
        "app/unitana/test/dashboard_header_button_mirror_test.dart",
        "docs/ai/context_db.json",
        "docs/ai/handoff/CURRENT_HANDOFF.md"
      ],
      "notes": {
        "root_cause": "Incomplete edit in the AppBar menu bottom sheet block (mismatched closure/brackets) caused dart format/analyze/test to fail at parse time.",
        "guards": [
          "Size equality widget test keyed to dashboard_tools_button and dashboard_menu_button.",
          "Header button sizing centralized via _HeaderIconButton size/radius constants to prevent drift when icons change."
        ],
        "risk": "Low; localized UI block repair + additive test + docs update."
      }
    },
    {
      "date": "2026-01-09",
      "id": "patch_2026-01-09_O12k13h1_header_button_exact_mirror_size",
      "slice": "O12k13h1",
      "title": "Hotfix: make header Tools/Menu buttons resolve to identical RenderBox size",
      "summary": [
        "Diagnosed failing mirror-size widget test: AppBar's leading slot constraints were forcing the Tools button subtree to resolve at 56x56 while Menu remained 44x44.",
        "Updated _HeaderIconButton's centralized size/radius to 56/28 (matching AppBar toolbar height) so both dashboard_tools_button and dashboard_menu_button report the same size.",
        "Kept changes localized (no key churn, no modal/ToolPicker changes); this aligns with the 'exact container equality' requirement."
      ],
      "files_changed": [
        "app/unitana/lib/features/dashboard/dashboard_screen.dart",
        "docs/ai/context_db.json",
        "docs/ai/handoff/CURRENT_HANDOFF.md"
      ],
      "notes": {
        "root_cause": "The mirror-size test was correct, but the left button was resolving under tighter AppBar leading constraints; the right button was not. The resulting RenderBox sizes differed (56 vs 44) despite shared widget code.",
        "guards": [
          "dashboard_header_button_mirror_test continues to assert equality using stable keys.",
          "Header button sizing remains centralized in _HeaderIconButton to prevent drift."
        ],
        "risk": "Low; only constants updated to match AppBar constraints."
      }
    },
    {
      "date": "2026-01-09",
      "id": "patch_2026-01-09_O12k13j_currency_modal_place_context",
      "slice": "O12k13j",
      "title": "Fix: Currency modal receives home/destination context from dashboard tiles",
      "summary": [
        "Dashboard tile taps now pass eurToUsd and home/destination Place context into ToolModalBottomSheet, ensuring Currency defaults and unit labels match the selected reality for non-US/EU home/destination pairs.",
        "Kept the change localized to DashboardBoard tile onTap, with no key churn and no ToolPicker behavior changes.",
        "Added a widget test that inverts the default assumption (EU home, US destination) and asserts the Currency modal unit line swaps correctly when toggling realities."
      ],
      "files_changed": [
        "app/unitana/lib/features/dashboard/widgets/dashboard_board.dart",
        "app/unitana/test/dashboard_currency_modal_context_test.dart",
        "docs/ai/context_db.json",
        "docs/ai/handoff/CURRENT_HANDOFF.md"
      ],
      "notes": {
        "root_cause": "DashboardBoard opened ToolModalBottomSheet from tile taps without passing home/destination context, so Currency inference fell back to a hardcoded USD/EUR pair. This broke correctness when Home was non-US or Destination was non-EU.",
        "guards": [
          "dashboard_currency_modal_context_test asserts the Currency modal unit line reflects actual home/destination currencies and swaps with the reality toggle.",
          "Currency inference continues to use device-clock-driven reality; timezones remain display-only."
        ],
        "risk": "Low; parameters are only added at the tile invocation site and are ignored by non-Currency tools."
      }
    },
    {
      "date": "2026-01-09",
      "id": "patch_2026-01-09_O12k13j1_currency_modal_test_dismiss",
      "slice": "O12k13j1",
      "title": "Test fix: Dismiss tool modal via ModalBarrier (bottom sheet), not Cupertino back",
      "summary": [
        "Fixed a widget test failure where tester.pageBack() expected a CupertinoNavigationBarBackButton, but tool modals are presented via showModalBottomSheet.",
        "Updated dashboard_currency_modal_context_test to dismiss the modal by tapping the ModalBarrier, keeping the assertion focused on currency directionality rather than navigation affordances.",
        "No production UI or logic changes; keys and tool behavior remain unchanged."
      ],
      "files_changed": [
        "app/unitana/test/dashboard_currency_modal_context_test.dart",
        "docs/ai/context_db.json",
        "docs/ai/handoff/CURRENT_HANDOFF.md"
      ],
      "notes": {
        "root_cause": "The Currency modal test used tester.pageBack(), which relies on finding a CupertinoNavigationBarBackButton. Tool modals use showModalBottomSheet and do not include that back button.",
        "guards": [
          "dashboard_currency_modal_context_test now dismisses the bottom sheet using ModalBarrier tap, matching the app's actual presentation model."
        ],
        "risk": "Very low; test-only change and docs update."
      }
    },
    {
      "date": "2026-01-09",
      "id": "patch_2026-01-09_O12k13j2_currency_modal_test_dismiss_reliable",
      "slice": "O12k13j2",
      "title": "Test fix: dismiss bottom sheet reliably (tapAt safe barrier region) + disable runtime font fetching",
      "summary": [
        "Fixed flaky/failing dismissal in dashboard_currency_modal_context_test where tapping ModalBarrier's center could land on the bottom sheet instead of the scrim, leaving the modal open and blocking subsequent taps.",
        "Updated dismissToolModal() to tap a safe top-left coordinate (outside the sheet) with warnIfMissed:false, retrying once if the barrier remains.",
        "Aligned with existing modal interaction tests by disabling GoogleFonts runtime fetching to avoid HttpClient warnings and reduce test noise."
      ],
      "files_changed": [
        "app/unitana/test/dashboard_currency_modal_context_test.dart",
        "docs/ai/context_db.json",
        "docs/ai/handoff/CURRENT_HANDOFF.md"
      ],
      "notes": {
        "root_cause": "A ModalBarrier finder can represent the whole scrim, but tester.tap(barrier.first) uses the widget center, which may be covered by the bottom sheet; the hit test then targets sheet content rather than the scrim, so dismissal does not occur.",
        "guards": [
          "dashboard_currency_modal_context_test now dismisses via tapAt(10,10) which is consistently outside the bottom sheet.",
          "GoogleFonts runtime fetching is disabled in-test, matching other interaction tests."
        ],
        "risk": "Very low; test-only change and docs update."
      }
    },
    {
      "date": "2026-01-09",
      "id": "patch_2026-01-09_O12k13j3_currency_modal_test_flutter_compat",
      "slice": "O12k13j3",
      "title": "Test fix: remove unsupported tapAt warnIfMissed param; dismiss via barrier top-left",
      "summary": [
        "Fixed build break on older Flutter where WidgetTester.tapAt() does not support warnIfMissed named parameter.",
        "Updated dashboard_currency_modal_context_test dismiss helper to tap a safe point derived from ModalBarrier top-left (fallback to a fixed point), with a single retry if the barrier remains."
      ],
      "files_changed": [
        "app/unitana/test/dashboard_currency_modal_context_test.dart",
        "docs/ai/context_db.json",
        "docs/ai/handoff/CURRENT_HANDOFF.md"
      ],
      "notes": {
        "root_cause": "The warnIfMissed parameter was added in newer Flutter; current repo toolchain does not include it, causing analyze/test compilation failure.",
        "guards": [
          "Modal dismissal remains deterministic by avoiding center-of-barrier taps that can hit-test into the bottom sheet.",
          "Test stays key-based and place-aware (EUR/USD inversion) to catch context regressions."
        ],
        "risk": "Very low; test-only change plus docs."
      }
    },
    {
      "date": "2026-01-09",
      "id": "patch_2026-01-09_O12k13j3_currency_modal_test_flutter_compat",
      "slice": "O12k13j3",
      "title": "Test fix: remove unsupported tapAt warnIfMissed param; dismiss via barrier top-left",
      "summary": [
        "Fixed a build/analyze failure where WidgetTester.tapAt() was called with an unsupported named parameter (warnIfMissed) in this repo's Flutter/Dart version.",
        "Kept the dismissal strategy stable by tapping the ModalBarrier top-left (safe scrim region) when present, with a fallback safe tap point and a single retry.",
        "No production code changes; test-only plus canonical docs updates."
      ],
      "files_changed": [
        "app/unitana/test/dashboard_currency_modal_context_test.dart",
        "docs/ai/context_db.json",
        "docs/ai/handoff/CURRENT_HANDOFF.md"
      ],
      "notes": {
        "root_cause": "warnIfMissed is not a valid named parameter for WidgetTester.tapAt() in the pinned Flutter SDK; compilation failed before tests could run.",
        "guards": [
          "dashboard_currency_modal_context_test now uses a Flutter-version-compatible tapAt() call.",
          "Modal dismissal targets the scrim (barrier top-left) so it is not occluded by the bottom sheet."
        ],
        "risk": "Very low; test-only change and docs update."
      }
    }
  ],
  "project": {
    "docs_root": "docs/",
    "name": "Unitana",
    "primary_app_path": "app/unitana/",
    "repo_root": "unitana/",
    "tagline": "travel-first decoder ring; dual reality side-by-side"
  },
  "schema_version": "1.0"
}
