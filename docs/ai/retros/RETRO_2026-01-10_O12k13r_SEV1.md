# Retro: O12k13r Sev 1 stabilization (pinned Hero cockpit + widget-test determinism)

Date: 2026-01-10

## Executive summary
A multi-step Sev 1 incident occurred while landing the Hero Cockpit “sticky/pinned overlay” work. The product behavior ended in a good state (pinned overlay keeps the Places Hero reality toggle actionable during scroll), but the majority of engineering time was consumed by a cascading loop of parse errors and widget-test instability. The repo is now green again.

## Impact
- Developer time: high. Multiple iterations spent on CI-gate recovery rather than feature progress.
- Scope drift risk: medium. Repeated micro-fixes increased the chance of accidental contract changes (keys, ToolPicker behaviors, test assumptions).
- User impact: none externally, as this was pre-release development.

## Primary root causes
1) **Patch stacking without a clean, single “source of truth” snapshot**
   - Applying many small changed-files zips in sequence made it easier to introduce bracket drift, partial merges, and mismatched assumptions across files.

2) **Widget tests depended on unstable interaction paths**
   - Tests were tapping dashboard tiles that could be occluded by overlays, and tapping ModalBarrier points that were not reliably hit-testable across Flutter SDK behaviors.
   - Tests also assumed ToolPicker lens expansion, ordering, or presence of per-lens rows.

3) **Flutter SDK surface-area mismatch**
   - Parameters like `warnIfMissed` were used in tests even though the pinned SDK version did not support them.

## What we changed that fixed it
- Standardized ToolPicker test interaction to a search-first path with stable keys.
- Standardized modal dismissal in tests to safe-corner taps rather than ModalBarrier hit-testing.
- Ensured scroll helpers pass a Scrollable finder (not CustomScrollView) to avoid cast errors.
- Consolidated the incident trail into canonical docs so future teams understand what actually happened.

## What went well
- Contracts held: stable keys and “one toolId per tool” remained intact.
- The pinned overlay cockpit shipped in an MVP form with the intended global-toggle behavior.
- The test suite was hardened against three common sources of flake: overlays, barrier taps, and lens layout coupling.

## What did not go well
- Too many cycles spent chasing symptoms rather than establishing a deterministic reproduction harness early.
- Documentation drift: patch_log fell behind real patches during the incident.

## Action items (concrete)
### Immediate
1) **Incident mode rule:** when the repo goes red, pause new UX work and fix the first gate in order (format, then analyze, then tests).
2) **Single patch per run:** do not stack multiple changed-files bundles before running all three gates.
3) **Snapshot discipline:** if more than 2 hotfixes are needed, re-zip a full repo snapshot and continue from that baseline.

### Near-term
4) Add a shared widget-test helper for bottom-sheet dismissal (corner taps + settle + assert sheet gone).
5) Add a shared helper for ToolPicker open-by-search (avoid lens coupling across all modal tests).
6) Add a tiny docs check: patch_log must be updated before any patch is considered “done.”

## Next slices (post-incident)
- C3c: Details-pill toggle (sunrise/sunset ↔ wind) with intrinsic affordance.
- Later: currency promotion in the cockpit (separate slice).
- Platform icon audit execution per the audit doc.