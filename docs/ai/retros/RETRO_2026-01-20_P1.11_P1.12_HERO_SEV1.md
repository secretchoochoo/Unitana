# RETRO 2026-01-20: Places Hero V2 Sev1 (P1.11 to P1.12)

## Incident
A Sev1 was declared due to repeated test failures and visible hero regressions while implementing Option 3 (two-bay hero).

## Symptoms
- RenderFlex bottom overflows in Env and Currency tiles under pathological widget-test constraints (inner box reached w=124, h=26 after padding).
- Phone surface contract failure: left rail width expected at least 150dp, actual measured around 120dp.
- Layout tweaks regressed frequently because multiple builders and mode branches were drifting apart inside `places_hero_v2.dart`.

## Root causes
- No single, authoritative collapse hierarchy. Micro mode existed, but some code paths still built a multi-line `Column` before the micro decision was applied.
- Minimum widths were expressed as intent (flex ratios) rather than enforced geometry (explicit allocation).
- Refactor drift and duplicate implementations increased blast radius. Fixes applied to one branch did not necessarily apply to the other.
- The test harness constraints were not treated as a first-class input. The tests were effectively asking for a clearly defined fallback shape.

## What worked
- Product decision to adopt Option 3 reduced surface area and bought width budget where it matters.
- Tests served as a reliable tripwire for regressions, especially around constrained layout and key stability.

## What fixed it
- Micro-first gating for Env and Currency. Mode selection now happens before constructing any multi-line content.
- Explicit width allocation with a protected left minimum, rather than relying on flexible children.
- Touch-target protection for normal surfaces where height budget permits.
- Key stability hardened. In particular, `hero_currency_primary_line` always resolves to a `Text` widget, even in micro mode.
- Refresh indicator contract clarified and enforced: a single label under the city header only.

## Guardrails going forward
- Centralize all hero geometry decisions in one allocator function.
- Avoid duplicate builders for the same hero sub-region. If a branch is needed, it must share the same sizing contract.
- When a region cannot meet its minimum height, it must switch modes, not overflow.

## Next work (P1.13)
The hero is stable. The next slice is a visual and proportion pass:
- Make Env, Currency, and Sunrise/Sunset pills look flatter vertically while keeping 44dp tap targets.
- Use the freed vertical space to restore marquee legibility.
- In normal mode, align the temperature vertically with the marquee.
