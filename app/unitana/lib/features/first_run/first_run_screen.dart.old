import 'package:flutter/material.dart';
import '../../app/app_state.dart';
import '../../features/dashboard/dashboard_screen.dart';
import '../../models/place.dart';
import '../../data/cities.dart';
import '../../widgets/city_picker.dart';

class FirstRunScreen extends StatefulWidget {
  final UnitanaAppState state;
  const FirstRunScreen({super.key, required this.state});

  @override
  State<FirstRunScreen> createState() => _FirstRunScreenState();
}

class _FirstRunScreenState extends State<FirstRunScreen> {
  int _step = 0; // 0 intro/profile, 1 home, 2 destination, 3 review
  bool _saving = false;

  final _profileNameCtrl = TextEditingController();

  City? _homeCity;
  City? _destCity;

  UnitSystem _homeUnit = UnitSystem.imperial;
  UnitSystem _destUnit = UnitSystem.metric;

  bool _homeUse24h = false; // US default
  bool _destUse24h = true; // EU default

  @override
  void initState() {
    super.initState();

    _profileNameCtrl.text = widget.state.profileName;

    // Seed defaults (still editable). We keep a default city so flow is fast,
    // but the picker supports Cancel so the user can back out without changes.
    _homeCity = kCities.firstWhere(
      (c) => c.cityName == 'Denver' && c.countryCode == 'US',
      orElse: () => kCities.first,
    );

    _destCity = kCities.firstWhere(
      (c) => c.cityName == 'Lisbon' && c.countryCode == 'PT',
      orElse: () => kCities.first,
    );

    _homeUnit = _homeCity?.defaultUnitSystem ?? UnitSystem.imperial;
    _destUnit = _destCity?.defaultUnitSystem ?? UnitSystem.metric;

    _homeUse24h = _defaultUse24hForCountry(_homeCity?.countryCode);
    _destUse24h = _defaultUse24hForCountry(_destCity?.countryCode);
  }

  @override
  void dispose() {
    _profileNameCtrl.dispose();
    super.dispose();
  }

  bool _defaultUse24hForCountry(String? cc) {
    if (cc == null) return true;
    return cc.toUpperCase() != 'US';
  }

  void _toast(String msg) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text(msg)),
    );
  }

  String? _validateStep() {
    if (_step == 0) {
      // Profile name optional; we still store a default.
      return null;
    }

    if (_step == 1) {
      if (_homeCity == null) {
        return 'Please choose a city for Home.';
      }
      return null;
    }

    if (_step == 2) {
      if (_destCity == null) {
        return 'Please choose a city for Destination.';
      }
      return null;
    }

    return null;
  }

  Future<void> _goTo(int step) async {
    setState(() => _step = step);
  }

  Future<void> _back() async {
    if (_step <= 0) return;
    await _goTo(_step - 1);
  }

  Future<void> _next() async {
    final err = _validateStep();
    if (err != null) {
      _toast(err);
      return;
    }

    if (_step == 0) {
      await widget.state.setProfileName(_profileNameCtrl.text);
      await _goTo(1);
      return;
    }

    if (_step == 1) {
      await _goTo(2);
      return;
    }

    if (_step == 2) {
      await _goTo(3);
      return;
    }
  }

  Future<void> _confirm() async {
    if (_saving) return;

    final err = _validateStep();
    if (err != null) {
      _toast(err);
      return;
    }

    setState(() => _saving = true);

    final profileName = _profileNameCtrl.text.trim().isEmpty
        ? 'My Places'
        : _profileNameCtrl.text.trim();

    await widget.state.setProfileName(profileName);

    final home = Place(
      id: 'home',
      name: 'Home',
      cityName: _homeCity!.cityName,
      countryCode: _homeCity!.countryCode,
      timeZoneId: _homeCity!.timeZoneId,
      unitSystem: _homeUnit,
      use24h: _homeUse24h,
    );

    final dest = Place(
      id: 'dest',
      name: 'Destination',
      cityName: _destCity!.cityName,
      countryCode: _destCity!.countryCode,
      timeZoneId: _destCity!.timeZoneId,
      unitSystem: _destUnit,
      use24h: _destUse24h,
    );

    // Persist a single "default place set" for now.
    // Minimal: store both records; default points to "home".
    await widget.state.savePlaceAsDefault(home);
    widget.state.places[dest.id] = dest;
    await widget.state.storage.savePlaces(widget.state.places);

    if (!mounted) return;

    setState(() => _saving = false);

    Navigator.of(context).pushReplacement(
      MaterialPageRoute(builder: (_) => DashboardScreen(state: widget.state)),
    );
  }

  String _primaryButtonLabel() {
    if (_step == 0) return 'Start';
    if (_step == 1) return 'Next';
    if (_step == 2) return 'Review';
    return _saving ? 'Saving…' : 'Confirm';
  }

  bool get _isConfirmStep => _step == 3;

  Widget _stepPill() {
    if (_step == 0) return const SizedBox.shrink();
    final n = _step.clamp(1, 3);
    return Text(
      'Step $n of 3',
      style: Theme.of(context).textTheme.bodyMedium,
    );
  }

  Future<void> _pickHomeCity() async {
    final picked = await showCityPicker(context, selected: _homeCity);
    if (picked == null) return;

    setState(() {
      _homeCity = picked;
      // If user hasn't changed anything, keep defaults region-smart.
      _homeUse24h = _defaultUse24hForCountry(picked.countryCode);
      _homeUnit = picked.defaultUnitSystem;
    });
  }

  Future<void> _pickDestCity() async {
    final picked = await showCityPicker(context, selected: _destCity);
    if (picked == null) return;

    setState(() {
      _destCity = picked;
      _destUse24h = _defaultUse24hForCountry(picked.countryCode);
      _destUnit = picked.defaultUnitSystem;
    });
  }

  Widget _segmentedUnit(UnitSystem value, ValueChanged<UnitSystem> onChanged) {
    return SegmentedButton<UnitSystem>(
      segments: const [
        ButtonSegment<UnitSystem>(
          value: UnitSystem.imperial,
          label: Text('Imperial'),
        ),
        ButtonSegment<UnitSystem>(
          value: UnitSystem.metric,
          label: Text('Metric'),
        ),
      ],
      selected: {value},
      onSelectionChanged: (s) => onChanged(s.first),
    );
  }

  Widget _segmentedClock(bool use24h, ValueChanged<bool> onChanged) {
    return SegmentedButton<bool>(
      segments: const [
        ButtonSegment<bool>(value: false, label: Text('12-hour')),
        ButtonSegment<bool>(value: true, label: Text('24-hour')),
      ],
      selected: {use24h},
      onSelectionChanged: (s) => onChanged(s.first),
    );
  }

  String _tempExample(UnitSystem primary) {
    if (primary == UnitSystem.metric) return '17°C / 63°F';
    return '63°F / 17°C';
  }

  String _windExample(UnitSystem primary) {
    if (primary == UnitSystem.metric) return '12 km/h / 7 mph';
    return '7 mph / 12 km/h';
  }

  String _timeExample(bool use24h) {
    return use24h ? '02:55' : '7:55 PM';
  }

  String _fxExample(String from, String to) {
    // Placeholder examples only (not live). We’ll replace with cached snapshots later.
    final key = '${from.toUpperCase()}_${to.toUpperCase()}';
    final rates = <String, double>{
      'USD_EUR': 0.92,
      'EUR_USD': 1.09,
      'USD_GBP': 0.79,
      'GBP_USD': 1.27,
      'EUR_GBP': 0.86,
      'GBP_EUR': 1.16,
    };

    final r = rates[key];
    if (r == null) return 'Example: 1 $from ≈ ? $to';
    return 'Example: 1 $from ≈ ${r.toStringAsFixed(2)} $to';
  }

  Widget _labelValue(String label, String value) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 6),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          SizedBox(
            width: 86,
            child: Text(
              '$label:',
              style: const TextStyle(fontWeight: FontWeight.w700),
            ),
          ),
          Expanded(child: Text(value)),
        ],
      ),
    );
  }

  Widget _profileCard() {
    final name = _profileNameCtrl.text.trim().isEmpty
        ? 'My Places'
        : _profileNameCtrl.text.trim();

    return Card(
      child: InkWell(
        onTap: () => _goTo(0),
        child: Padding(
          padding: const EdgeInsets.all(16),
          child: _labelValue('Profile', name),
        ),
      ),
    );
  }

  Widget _placeReviewCard({
    required String title,
    required VoidCallback onTap,
    required City city,
    required UnitSystem unit,
    required bool use24h,
    required String fxLine,
  }) {
    return Card(
      child: InkWell(
        onTap: onTap,
        child: Padding(
          padding: const EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                children: [
                  Expanded(
                    child: Text(
                      title,
                      style: Theme.of(context).textTheme.titleLarge,
                    ),
                  ),
                  const Icon(Icons.chevron_right),
                ],
              ),
              const SizedBox(height: 10),
              _labelValue('City', city.displayLabel),
              _labelValue('Time', _timeExample(use24h)),
              _labelValue('Temp', _tempExample(unit)),
              _labelValue('Wind', _windExample(unit)),
              _labelValue('Zone', city.timeZoneId),
              _labelValue('Currency', city.currencyCode),
              _labelValue('FX', fxLine),
            ],
          ),
        ),
      ),
    );
  }

  Widget _intro() {
    return Padding(
      padding: const EdgeInsets.fromLTRB(16, 18, 16, 0),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'Welcome to Unitana',
            style: Theme.of(context).textTheme.displaySmall,
          ),
          const SizedBox(height: 10),
          Text(
            'Two systems. One glance.',
            style: Theme.of(context).textTheme.titleMedium,
          ),
          const SizedBox(height: 18),
          TextField(
            controller: _profileNameCtrl,
            textInputAction: TextInputAction.done,
            decoration: const InputDecoration(
              labelText: 'Name your Places',
              hintText: 'Portugal Move',
            ),
          ),
          const SizedBox(height: 12),
          Text(
            'Set up Home and Destination, then we pin the essentials to your dashboard.',
            style: Theme.of(context).textTheme.bodyLarge,
          ),
        ],
      ),
    );
  }

  Widget _home() {
    final city = _homeCity;

    return Padding(
      padding: const EdgeInsets.fromLTRB(16, 18, 16, 0),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          _stepPill(),
          const SizedBox(height: 8),
          Text(
            'Home',
            style: Theme.of(context).textTheme.displaySmall,
          ),
          const SizedBox(height: 10),
          Text(
            'Your home base. The defaults you already think in.',
            style: Theme.of(context).textTheme.titleMedium,
          ),
          const SizedBox(height: 18),
          ListTile(
            contentPadding: EdgeInsets.zero,
            title: const Text('City'),
            subtitle: Text(city == null
                ? 'Choose a city'
                : '${city.displayLabel}  •  ${city.timeZoneId}'),
            trailing: const Icon(Icons.chevron_right),
            onTap: _pickHomeCity,
          ),
          const SizedBox(height: 12),
          Text('Unit system', style: Theme.of(context).textTheme.titleMedium),
          const SizedBox(height: 8),
          _segmentedUnit(_homeUnit, (v) => setState(() => _homeUnit = v)),
          const SizedBox(height: 18),
          Text('Clock preference', style: Theme.of(context).textTheme.titleMedium),
          const SizedBox(height: 8),
          _segmentedClock(_homeUse24h, (v) => setState(() => _homeUse24h = v)),
        ],
      ),
    );
  }

  Widget _destination() {
    final city = _destCity;

    return Padding(
      padding: const EdgeInsets.fromLTRB(16, 18, 16, 0),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          _stepPill(),
          const SizedBox(height: 8),
          Text(
            'Destination',
            style: Theme.of(context).textTheme.displaySmall,
          ),
          const SizedBox(height: 10),
          Text(
            'Practice translating less and recognizing more.',
            style: Theme.of(context).textTheme.titleMedium,
          ),
          const SizedBox(height: 18),
          ListTile(
            contentPadding: EdgeInsets.zero,
            title: const Text('City'),
            subtitle: Text(city == null
                ? 'Choose a city'
                : '${city.displayLabel}  •  ${city.timeZoneId}'),
            trailing: const Icon(Icons.chevron_right),
            onTap: _pickDestCity,
          ),
          const SizedBox(height: 12),
          Text('Unit system', style: Theme.of(context).textTheme.titleMedium),
          const SizedBox(height: 8),
          _segmentedUnit(_destUnit, (v) => setState(() => _destUnit = v)),
          const SizedBox(height: 18),
          Text('Clock preference', style: Theme.of(context).textTheme.titleMedium),
          const SizedBox(height: 8),
          _segmentedClock(_destUse24h, (v) => setState(() => _destUse24h = v)),
        ],
      ),
    );
  }

  Widget _review() {
    final homeCity = _homeCity!;
    final destCity = _destCity!;

    final homeFx = _fxExample(homeCity.currencyCode, destCity.currencyCode);
    final destFx = _fxExample(destCity.currencyCode, homeCity.currencyCode);

    return Padding(
      padding: const EdgeInsets.fromLTRB(16, 18, 16, 0),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          _stepPill(),
          const SizedBox(height: 8),
          Text(
            'Review',
            style: Theme.of(context).textTheme.displaySmall,
          ),
          const SizedBox(height: 10),
          Text(
            'A quick preview of what your dashboard will pin at the top.',
            style: Theme.of(context).textTheme.titleMedium,
          ),
          const SizedBox(height: 14),
          _profileCard(),
          _placeReviewCard(
            title: 'Home',
            onTap: () => _goTo(1),
            city: homeCity,
            unit: _homeUnit,
            use24h: _homeUse24h,
            fxLine: homeFx,
          ),
          _placeReviewCard(
            title: 'Destination',
            onTap: () => _goTo(2),
            city: destCity,
            unit: _destUnit,
            use24h: _destUse24h,
            fxLine: destFx,
          ),
        ],
      ),
    );
  }

  Widget _bodyForStep() {
    switch (_step) {
      case 0:
        return _intro();
      case 1:
        return _home();
      case 2:
        return _destination();
      case 3:
        return _review();
      default:
        return _intro();
    }
  }

  Widget _bottomBar() {
    final primaryLabel = _primaryButtonLabel();

    if (_step == 0) {
      return SafeArea(
        top: false,
        child: Padding(
          padding: const EdgeInsets.fromLTRB(16, 12, 16, 16),
          child: SizedBox(
            height: 54,
            width: double.infinity,
            child: FilledButton(
              onPressed: _saving ? null : _next,
              child: Text(primaryLabel),
            ),
          ),
        ),
      );
    }

    return SafeArea(
      top: false,
      child: Padding(
        padding: const EdgeInsets.fromLTRB(16, 12, 16, 16),
        child: Row(
          children: [
            Expanded(
              child: SizedBox(
                height: 54,
                child: OutlinedButton(
                  onPressed: _saving ? null : _back,
                  child: const Text('Back'),
                ),
              ),
            ),
            const SizedBox(width: 12),
            Expanded(
              child: SizedBox(
                height: 54,
                child: FilledButton(
                  onPressed: _saving
                      ? null
                      : (_isConfirmStep ? _confirm : _next),
                  child: Text(primaryLabel),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final scrollable = SingleChildScrollView(
      padding: const EdgeInsets.only(bottom: 8),
      child: _bodyForStep(),
    );

    return Scaffold(
      appBar: AppBar(
        title: const Text('Unitana'),
        centerTitle: true,
        automaticallyImplyLeading: false,
      ),
      body: scrollable,
      bottomNavigationBar: _bottomBar(),
    );
  }
}
